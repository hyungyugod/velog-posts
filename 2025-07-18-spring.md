# ğŸ“Œ 0. ë³´ìŠ¤ í´ë¡ ì½”ë”© í”„ë¡œì íŠ¸
### ğŸ“Œ 0-1. ê²°ì œì— ì¥ë°”êµ¬ë‹ˆì—ì„œ ì£¼ë¬¸ ë°˜ë³µí•˜ë©´ ì£¼ë¬¸ì„œê°€ ê³„ì† ìƒê¸°ëŠ” ë¬¸ì œ
- mapperì—ì„œ ê²°ì œëŒ€ê¸°ì¤‘ì´ë¼ëŠ” ìƒíƒœë¥¼ ë¯¸ë¦¬ ì§€ì •í•˜ì—¬ ê°ì²´ì— ë„£ì–´ì£¼ë©´ í•´ë‹¹ ìƒíƒœì— ìˆëŠ” ì£¼ë¬¸ì„œë§Œ ì¶”ì¶œí•œë‹¤.
- ê°™ìœ¼ë©´ ë¹ ë¥´ê²Œ ë©ˆì¶°ì•¼í•˜ê¸° ë•Œë¬¸ì— ê°€ì¥ ìµœì‹  ì •ë³´ë¶€í„° (ë‚´ë¦¼ì°¨ìˆœ) ë¶ˆëŸ¬ì™€ì•¼í•œë‹¤.
```java
/**
     * ì‚¬ìš©ìì˜ íŠ¹ì • ìƒíƒœì— ë”°ë¥¸ ì£¼ë¬¸ ëª©ë¡ì„ ì¡°íšŒ
     * 
     * @param input - ì‚¬ìš©ì IDì™€ ì£¼ë¬¸ ìƒíƒœê°€ í¬í•¨ëœ Order ê°ì²´
     * @return List<Order> - íŠ¹ì • ìƒíƒœì˜ ì£¼ë¬¸ ëª©ë¡
     */
    @Select("SELECT"
            + " order_id, user_id, order_number, receiver_name, receiver_phone, receiver_postcode, receiver_address, receiver_specific_address, receiver_memo, order_status, order_price, delivery_method, delivery_price, purchase_term, purchase_method, reg_date, edit_date"
            + " FROM orders"
            + " WHERE user_id = #{userId} AND order_status = #{orderStatus}"
            + " ORDER BY reg_date DESC")
    @ResultMap("orderMap")
    public List<Order> selectPendingOrdersByUserId(Order input);
```
- serviceì—ì„œëŠ” ìš°ì„  í•´ë‹¹ ìœ ì €ì˜ ê²°ì œëŒ€ê¸°ì¤‘ì¸ ëª¨ë“  ìƒí’ˆì„ ê°€ì ¸ì™€ì„œ í˜„ì¬ ìƒí’ˆê³¼ ë¹„êµí•œë‹¤.
- ë¹„êµëŠ” ì•„ë˜ì— ìˆëŠ” ë”°ë¡œ ì •ì˜í•œ ë©”ì„œë“œë¥¼ í†µí•´ ì´ë£¨ì–´ì§„ë‹¤.
```java
@Override
    public Order findExistingPendingOrder(int userId, List<OrderProduct> orderProducts) throws Exception {
        // ì‚¬ìš©ìì˜ ê²°ì œëŒ€ê¸°ì¤‘ ì£¼ë¬¸ë“¤ì„ ì¡°íšŒ
        Order searchInput = new Order();
        searchInput.setUserId(userId);
        searchInput.setOrderStatus("ê²°ì œëŒ€ê¸°ì¤‘");
        
        List<Order> pendingOrders = orderMapper.selectPendingOrdersByUserId(searchInput);
        
        if (pendingOrders == null || pendingOrders.isEmpty()) {
            return null;
        }
        
        // ê° ê²°ì œëŒ€ê¸°ì¤‘ ì£¼ë¬¸ì˜ ìƒí’ˆ êµ¬ì„±ì„ í™•ì¸
        for (Order existingOrder : pendingOrders) {
            OrderProduct input = new OrderProduct();
            input.setOrderId(existingOrder.getOrderId());
            List<OrderProduct> existingProducts = orderProductMapper.selectOrderProductListByOrderId(input);
            
            // ìƒí’ˆ êµ¬ì„±ì´ ë™ì¼í•œì§€ í™•ì¸
            if (isSameOrderComposition(orderProducts, existingProducts)) {
                return existingOrder;
            }
        }
        
        return null;
    }
```
- ìµœì‹ ìƒí’ˆë¶€í„° ì¡°íšŒí•˜ë©´ì„œ ìƒí’ˆid, ìƒ‰ìƒid, ìˆ˜ëŸ‰ì´ ê°™ìœ¼ë©´ trueë¥¼ ë°˜í™˜í•œë‹¤. ë°œê²¬í•˜ë©´ í•´ë‹¹ ì£¼ë¬¸ì„œë¥¼ ë°˜í™˜í•œë‹¤.
```java
private boolean isSameOrderComposition(List<OrderProduct> newProducts, List<OrderProduct> existingProducts) {
        if (newProducts.size() != existingProducts.size()) {
            return false;
        }
        
        // ìƒˆë¡œìš´ ìƒí’ˆ ëª©ë¡ì˜ ê° ìƒí’ˆì´ ê¸°ì¡´ ëª©ë¡ì— ë™ì¼í•œ ìˆ˜ëŸ‰ìœ¼ë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        for (OrderProduct newProduct : newProducts) {
            boolean found = false;
            for (OrderProduct existingProduct : existingProducts) {
                if (newProduct.getProductId() == existingProduct.getProductId() &&
                    newProduct.getColorId() == existingProduct.getColorId() &&
                    newProduct.getOrderQuantity() == existingProduct.getOrderQuantity()) {
                    found = true;
                    break;
                }
            }
            if (!found) {
                return false;
            }
        }
        
        return true;
    }
```
- ê¸°ì¡´ ì£¼ë¬¸ì´ ìˆìœ¼ë©´ ê·¸ ì£¼ë¬¸ì„ ì‚¬ìš©í•˜ë©´ ìˆìœ¼ë©´ í•´ë‹¹ ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ê³  ìƒˆë¡œìš´ ì£¼ë¬¸ì„ ìƒì„±í•˜ëŠ” ì ˆì°¨ë¥¼ ì‹œí–‰í•˜ì§€ ì•ŠëŠ”ë‹¤.
- ê·¸ë¦¬ê³  ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ê·¸ëŒ€ë¡œ ë¦¬í„´í•œë‹¤.
```java
// ë¨¼ì € ë™ì¼í•œ ìƒí’ˆ êµ¬ì„±ì˜ ê²°ì œëŒ€ê¸°ì¤‘ ì£¼ë¬¸ì´ ìˆëŠ”ì§€ í™•ì¸
    Order existingOrder = paymentService.findExistingPendingOrder(member.getUserId(), orderProducts);
    
    String orderNumber;
    if (existingOrder != null) {
        // ê¸°ì¡´ ì£¼ë¬¸ì´ ìˆìœ¼ë©´ í•´ë‹¹ ì£¼ë¬¸ë²ˆí˜¸ ì‚¬ìš©
        orderNumber = existingOrder.getOrderNumber();
    } else {
        // ìƒˆë¡œìš´ ì£¼ë¬¸ ìƒì„±
        // ì£¼ë¬¸ ë²ˆí˜¸ ìƒì„±: ë‚ ì§œì‹œê°„ + ì‚¬ìš©ìID
        LocalDateTime now = LocalDateTime.now();
        String dateTime = now.format(DateTimeFormatter.ofPattern("yyyyMMddHHmmss"));
        orderNumber = dateTime + member.getUserId();
        
        // ì£¼ë¬¸ ì´ì•¡ ê³„ì‚°
        int totalOrderPrice = orderProducts.stream()
                .mapToInt(op -> op.getOrderProductPrice() * op.getOrderQuantity())
                .sum();
        
        // Order ê°ì²´ ìƒì„±
        Order order = new Order();
        order.setUserId(member.getUserId());
        order.setOrderNumber(orderNumber);
        order.setOrderStatus("ê²°ì œëŒ€ê¸°ì¤‘");
        order.setOrderPrice(totalOrderPrice);
        
        // orders í…Œì´ë¸”ì— ì£¼ë¬¸ ì •ë³´ ì €ì¥
        paymentService.addOrderAndProduct(order, orderProducts);
    }
```

### ğŸ“Œ 0-2. ì•„ì„í¬íŠ¸ë¡œ ê²°ì œê¸°ëŠ¥ êµ¬í˜„
- ê¸°ì¡´ ê²°ì œ ë²„íŠ¼ -> ì„±ê³µí˜ì´ì§€ë¡œ ë„˜ì–´ê°€ê¸° ì „ì— ì£¼ë¬¸ì •ë³´ë¥¼ ì €ì¥í•˜ë˜ apií˜¸ì¶œ ì¤‘ê°„ì— ê²°ì œ ì°½ì„ ë„ìš°ëŠ” ë¡œì§ì„ ì¶”ê°€í•œë‹¤.
- !paymentService.verifyPayment(impUid, merchantUid, expectedAmount)ë¥¼ í†µí•´ ê²°ì œê°€ ì˜ ì´ë£¨ì–´ì¡ŒëŠ”ì§€ í‰ê°€í•˜ëŠ” ê²ƒì´ë‹¤.
- BigDecimal ì°¸ê³ ë¡œ ì´ëŠ” ê²°ì œ ì‹œìŠ¤í…œì—ì„œ ëˆ ê³„ì‚°ì˜ ì •í™•ì„±ì„ ë³´ì¥í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ì—ˆë‹¤. ì†Œìˆ«ì  ê³„ì‚°ì´ í˜¹ì‹œ ì¡°ê¸ˆë§Œ ë‹¬ë¼ì ¸ë„ ê²°ì œ ê²€ì¦ì´ ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì´ë‹¤.
```java
@PostMapping("/api/payment/complete")
        @Transactional(rollbackFor = Exception.class)
        public ResponseEntity<ResponseDTO> completePayment(
                @RequestParam(value = "orderNumber") String orderNumber,
                @RequestParam(value = "receiverName") String receiverName,
                @RequestParam(value = "receiverPhone") String receiverPhone,
                @RequestParam(value = "receiverPostcode") String receiverPostcode,
                @RequestParam(value = "receiverAddress") String receiverAddress,
                @RequestParam(value = "receiverDetailAddress") String receiverDetailAddress,
                @RequestParam(value = "deliveryMemo", required = false) String deliveryMemo,
                @RequestParam(value = "paymentMethod") String paymentMethod,
                @RequestParam(value = "purchaseTerm") boolean purchaseTerm,
                @RequestParam(value = "deliveryPrice") int deliveryPrice,
                @RequestParam(value = "impUid", required = false) String impUid,
                @RequestParam(value = "merchantUid", required = false) String merchantUid,
                @RequestParam(value = "paidAmount", required = false) Integer paidAmount,
                @SessionAttribute("memberInfo") User member) throws Exception {
                
                String validReceiverName = validationManager.validateName(receiverName);
                String validReceiverPhone = validationManager.validatePhone(receiverPhone);
                String validReceiverPostcode = validationManager.validatePostcode(receiverPostcode);
                String validReceiverAddress = validationManager.validateAddress(receiverAddress);
                String validReceiverDetailAddress = validationManager.validateAddressDetail(receiverDetailAddress, receiverAddress);
                    
                    // í•„ìˆ˜ ì•½ê´€ ë™ì˜ ê²€ì¦
                    if (!purchaseTerm) {
                        throw new InvalidFormatException("í•„ìˆ˜ ì•½ê´€ì— ë™ì˜í•´ì•¼ í•©ë‹ˆë‹¤.");
                    }
                    
                    // ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ ë° ì†Œìœ ì í™•ì¸
                    Order order = paymentService.getOrderByNumber(orderNumber);
                    if (order == null) {
                            throw new InternalServerErrorException("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì£¼ë¬¸ì…ë‹ˆë‹¤.");
                    }
                    
                    if (order.getUserId() != member.getUserId()) {
                            throw new InternalServerErrorException("í•´ë‹¹ ì£¼ë¬¸ì— ëŒ€í•œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
                    }
                    
                    // ì£¼ë¬¸ ìƒíƒœê°€ "ê²°ì œëŒ€ê¸°ì¤‘"ì¸ì§€ í™•ì¸
                    if (!"ê²°ì œëŒ€ê¸°ì¤‘".equals(order.getOrderStatus())) {
                            throw new InternalServerErrorException("ì´ë¯¸ ì²˜ë¦¬ëœ ì£¼ë¬¸ì…ë‹ˆë‹¤.");
                    }
                    
                    // ì•„ì„í¬íŠ¸ ê²°ì œ ê²€ì¦ (ì•„ì„í¬íŠ¸ ê²°ì œì¸ ê²½ìš°ì—ë§Œ)
                    if (impUid != null && merchantUid != null && paidAmount != null) {
                        // ì˜ˆìƒ ê²°ì œ ê¸ˆì•¡ ê³„ì‚° (ìƒí’ˆ ê¸ˆì•¡ + ë°°ì†¡ë¹„)
                        BigDecimal expectedAmount = BigDecimal.valueOf(order.getOrderPrice() + deliveryPrice);
                        
                        // ì•„ì„í¬íŠ¸ ê²°ì œ ê²€ì¦
                        if (!paymentService.verifyPayment(impUid, merchantUid, expectedAmount)) {
                            throw new InternalServerErrorException("ê²°ì œ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        }
                    }   
                    
                      // ë°°ì†¡ ì •ë³´ ë° ê²°ì œ ë°©ë²• ì—…ë°ì´íŠ¸ (ê²€ì¦ëœ ê°’ ì‚¬ìš©)
                    order.setReceiverName(validReceiverName);
                    order.setReceiverPhone(validReceiverPhone);
                    order.setReceiverPostcode(validReceiverPostcode);
                    order.setReceiverAddress(validReceiverAddress);
                    order.setReceiverSpecificAddress(validReceiverDetailAddress);
                    
                    // ë°°ì†¡ë©”ëª¨ ì²˜ë¦¬: ë¹ˆ ë¬¸ìì—´ì´ê±°ë‚˜ ê¸°ë³¸ ì„ íƒê°’ì¸ ê²½ìš° nullë¡œ ì²˜ë¦¬
                    if (deliveryMemo == null || deliveryMemo.trim().isEmpty() || 
                        "ë°°ì†¡ë©”ëª¨ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.".equals(deliveryMemo.trim())) {
                        order.setReceiverMemo(null);
                    } else {
                        order.setReceiverMemo(deliveryMemo.trim());
                    }
                    
                    order.setPurchaseMethod(paymentMethod);
                    order.setPurchaseTerm(purchaseTerm);
                    order.setDeliveryPrice(deliveryPrice);
                    order.setOrderStatus("ë°°ì†¡ì¤€ë¹„ì¤‘");
                    
                    // ì£¼ë¬¸ ì •ë³´ ì—…ë°ì´íŠ¸
                    paymentService.updateOrderForPayment(order);
                    
                    // ì£¼ë¬¸ ì™„ë£Œ í›„ í•´ë‹¹ ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì—ì„œ ì œê±°
                    paymentService.removeOrderedItemsFromCart(orderNumber);
                    
                    // ì‘ë‹µ ë°ì´í„° êµ¬ì„±
                    Map<String, Object> responseData = new HashMap<>();
                    responseData.put("orderNumber", orderNumber);
                    
                    ResponseDTO response = ResponseDTO.builder()
                            .success(true)
                            .message("ê²°ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
                            .data(responseData)
                            .timestamp(LocalDateTime.now())
                            .build();

                    return ResponseEntity.ok(response);
        }
```
- ì•„ì„í¬íŠ¸ ê´€ë ¨í•´ì„œ ì¶”ê°€í•´ì•¼í•  í•„ë“œë“¤ì„ ì¶”ê°€í•´ì¤€ë‹¤.
- IAMPORT_API_URLì€ importì™€ ì—°ë™í•˜ê¸° ìœ„í•œ ì£¼ì†Œì´ë‹¤.
- iamport.api.keyì™€ iamport.api.secretëŠ” ë‚´ê°€ ê°€ì§€ê³  ìˆëŠ” ê³ ìœ í‚¤ì´ë‹¤.
- RestTemplate ì€ ì™¸ë¶€ apië¥¼ í˜¸ì¶œí•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ì•„ì„í¬íŠ¸ API ì„œë²„ì™€ í†µì‹ í•˜ì—¬ í† í°ì„ ë°œê¸‰ë°›ê³  ê²°ì œ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê¸° ìœ„í•´ ì‚¬ìš©í•œë‹¤. ë‹¤ë§Œ ë™ê¸°ì²˜ë¦¬ ë°©ì‹ì´ë¼ ë‚˜ì¤‘ì— web clientë¡œ ë°”ê¿”ì•¼í•  ê²ƒ ê°™ë‹¤.
- ObjectMapperëŠ” JSON â†” Java ê°ì²´ ë³€í™˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ (Jackson)ë¡œ ì•„ì„í¬íŠ¸ì˜ api ì‘ë‹µì„ JsonNodeë¡œ íŒŒì‹±í•˜ê³  ìˆë‹¤.
```java
// ì•„ì„í¬íŠ¸ ê´€ë ¨ í•„ë“œ
    private static final String IAMPORT_API_URL = "https://api.iamport.kr";
    
    @Value("${iamport.api.key}")
    private String apiKey;
    
    @Value("${iamport.api.secret}")
    private String apiSecret;
    
    private final RestTemplate restTemplate = new RestTemplate();
    private final ObjectMapper objectMapper = new ObjectMapper(); 
```
- String url = IAMPORT_API_URL + "/users/getToken"; ëŠ” ì•„ì„í¬íŠ¸ì—ì„œ í† í°ì„ ë°œê¸‰ë°›ëŠ” api ì£¼ì†Œì´ë‹¤.
- ì¤‘ìš”: application/x-www-form-urlencoded í˜•ì‹ìœ¼ë¡œ ì„¤ì • ì´ëŠ” HTML í¼ ë°ì´í„° í˜•ì‹ìœ¼ë¡œ, JSONì´ ì•„ë‹Œ í¼ ë°ì´í„°ë¡œ ì „ì†¡í•´ì•¼ í•¨ì„ ì˜ë¯¸í•œë‹¤. ì›ë˜ json í˜•ì‹ì´ì—ˆë‹¤ê°€ ë³€ê²½í•˜ì˜€ë‹¤.
- MultiValueMap<String, String> body = new LinkedMultiValueMap<>(); ì—ì„œ MultiValueMapëŠ” í¼ë°ì´í„°ë¥¼ í‘œí˜„í•˜ëŠ” ìë£Œêµ¬ì¡°ì´ë‹¤. ì—¬ê¸°ì— ì•„ì„í¬íŠ¸ì—ì„œ ë°œê¸‰ë°›ì€ API í‚¤ì™€ ì•„ì„í¬íŠ¸ì—ì„œ ë°œê¸‰ë°›ì€ API ì‹œí¬ë¦¿ì„ ì¶”ê°€í•˜ì—¬ ì „ì†¡í•œë‹¤.
- HttpEntity<MultiValueMap<String, String>> request = new HttpEntity<>(body, headers); ì´ë ‡ê²Œ http ìš”ì²­ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ ì¤€ë¹„í•œë‹¤. 
- esponseEntity<String> response = restTemplate.postForEntity(url, request, String.class); ì—¬ê¸°ì„œ postForEntityëŠ” post ìš”ì²­ì„ ë³´ë‚´ê³  ì‘ë‹µì„ ë°›ëŠ”ë‹¤ëŠ” ëœ»ì´ë‹¤. ì‘ë‹µì€ JSON ë¬¸ìì—´ë¡œ ë°›ì•„ ì‚¬ìš©í•œë‹¤.
- JsonNode jsonNode = objectMapper.readTree(response.getBody()); ì´ë¥¼ í†µí•´ ë°›ì€ ì‘ë‹µì„ íŒŒì‹±í•œë‹¤.
- ì‘ë‹µ ì—¬í•˜ì— ëŒ€í•œ êµ¬ì¡°ëŠ” ì´ ì½”ë“œ ì•„ë˜ì— ë³„ì²¨í•œë‹¤.
```java
/**
     * ì•„ì„í¬íŠ¸ API ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰
     * @return String - ë°œê¸‰ëœ ì•¡ì„¸ìŠ¤ í† í°
     * @throws Exception - ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰ ì‹¤íŒ¨ ì‹œ
     */
    private String getAccessToken() throws Exception {
        String url = IAMPORT_API_URL + "/users/getToken";
        
        // Content-Typeì„ application/x-www-form-urlencodedë¡œ ì„¤ì •
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);
        
        // MultiValueMapì„ ì‚¬ìš©í•˜ì—¬ form ë°ì´í„° êµ¬ì„±
        MultiValueMap<String, String> body = new LinkedMultiValueMap<>();
        body.add("imp_key", apiKey);
        body.add("imp_secret", apiSecret);
        
        HttpEntity<MultiValueMap<String, String>> request = new HttpEntity<>(body, headers);
        
        ResponseEntity<String> response = restTemplate.postForEntity(url, request, String.class);
        JsonNode jsonNode = objectMapper.readTree(response.getBody());
        
        if (jsonNode.get("code").asInt() == 0) {
            return jsonNode.get("response").get("access_token").asText();
        } else {
            throw new Exception("ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰ ì‹¤íŒ¨: " + jsonNode.get("message").asText());
        }
    }
```
- ì„±ê³µ ì‘ë‹µ êµ¬ì¡° (codeê°€ 0ì¸ ê²½ìš°)
```js
{
  "code": 0,
  "message": null,
  "response": {
    "access_token": "ì‹¤ì œ_í† í°_ê°’",
    "expired_at": 1234567890
  }
}
```
- ì‹¤íŒ¨ ì‘ë‹µ êµ¬ì¡° (codeê°€ 0ì´ ì•„ë‹Œ ê²½ìš°)
```js
{
  "code": -1,
  "message": "ì˜¤ë¥˜ ë©”ì‹œì§€",
  "response": null
}
}
```
- ì•„ì„í¬íŠ¸ ê²°ì œ ì¡°íšŒ API ì£¼ì†Œ: https://api.iamport.kr/payments/{imp_uid} í˜•ì‹ìœ¼ë¡œ ì£¼ì†Œë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤.
- headers.set("Authorization", "Bearer " + accessToken); ì€ Authorization: Bearer í† í° ë°©ì‹ì˜ ì¸ì¦ í—¤ë”ë¡œ í˜•ì‹ì€ Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...ì´ë‹¤. ì´ëŠ” ì´ì „ ë‹¨ê³„ì—ì„œ ë°œê¸‰ë°›ì€ accessTokenì„ ì‚¬ìš©í•œë‹¤.
- HttpEntity<Void> request = new HttpEntity<>(headers); í—¤ë”ë§Œ ë‹´ì•„ì„œ getìš”ì²­ìœ¼ë¡œ ë³´ë‚¸ë‹¤. ResponseEntity<String> response = restTemplate.exchange(url, HttpMethod.GET, request, String.class); ì´ëŸ°ì‹ìœ¼ë¡œ
- JsonNode jsonNode = objectMapper.readTree(response.getBody()); ì—­ì‹œ jsonì„ íŒŒì‹±í•˜ì—¬ ì‘ë‹µì„ ë°›ëŠ”ë‹¤.
- ì„±ê³µì—¬í•˜ì— ë”°ë¥¸ ë‹µë³€êµ¬ì¡°ëŠ” ì•„ë˜ì— ë³„ì²¨í•œë‹¤.
```java
    /**
     * ê²°ì œ ì •ë³´ ì¡°íšŒ
     * 
     * @param accessToken - ë°œê¸‰ëœ ì•¡ì„¸ìŠ¤ í† í°
     * @param impUid - ì•„ì„í¬íŠ¸ ê²°ì œ ê³ ìœ  ID
     * @return JsonNode - ì¡°íšŒëœ ê²°ì œ ì •ë³´
     * @throws Exception - ê²°ì œ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ
     */
    private JsonNode getPaymentInfo(String accessToken, String impUid) throws Exception {
        String url = IAMPORT_API_URL + "/payments/" + impUid;
        
        HttpHeaders headers = new HttpHeaders();
        headers.set("Authorization", "Bearer " + accessToken);
        
        HttpEntity<Void> request = new HttpEntity<>(headers);
        
        ResponseEntity<String> response = restTemplate.exchange(url, HttpMethod.GET, request, String.class);
        JsonNode jsonNode = objectMapper.readTree(response.getBody());
        
        if (jsonNode.get("code").asInt() == 0) {
            return jsonNode.get("response");
        } else {
            throw new Exception("ê²°ì œ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: " + jsonNode.get("message").asText());
        }
    }
```
- ì„±ê³µ ì‘ë‹µ êµ¬ì¡° (codeê°€ 0ì¸ ê²½ìš°):
```js
{
  "code": 0,
  "message": null,
  "response": {
    "imp_uid": "imp_123456789",
    "merchant_uid": "order_20230717_001",
    "pay_method": "card",
    "channel": "pc",
    "pg_provider": "uplus",
    "status": "paid",
    "amount": 29000,
    "currency": "KRW",
    "buyer_name": "í™ê¸¸ë™",
    "buyer_email": "test@example.com",
    "paid_at": 1689580800,
    // ... ê¸°íƒ€ ê²°ì œ ìƒì„¸ ì •ë³´
  }
}
```
- ì‹¤íŒ¨ ì‘ë‹µ êµ¬ì¡° (codeê°€ 0ì´ ì•„ë‹Œ ê²½ìš°):
```js

  "code": -1,
  "message": "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²°ì œì •ë³´ì…ë‹ˆë‹¤",
  "response": null
}
```
- ìœ„ì—ì„œ ë°›ì€ ì •ë³´ë“¤ì„ í† ëŒ€ë¡œ ê²°ì œì •ë³´ë¥¼ ê²€ì¦í•œë‹¤.
- ê°€ë§¹ì  ë²ˆí˜¸, ê²°ì œ ê¸ˆì•¡, ì¡°íšŒëœ ê²°ì œ ì •ë³´ì—ì„œ ìƒíƒœë¥¼ ê²€ì¦í•œë‹¤.
```java
    /**
     * ê²°ì œ ì •ë³´ ê²€ì¦
     * 
     * @param paymentInfo - ì¡°íšŒëœ ê²°ì œ ì •ë³´
     * @param merchantUid - ê°€ë§¹ì  ì£¼ë¬¸ë²ˆí˜¸
     * @param expectedAmount - ì˜ˆìƒ ê²°ì œ ê¸ˆì•¡
     * @return boolean - ê²€ì¦ ì„±ê³µ ì—¬ë¶€
     */
    private boolean validatePaymentInfo(JsonNode paymentInfo, String merchantUid, BigDecimal expectedAmount) {
        // merchant_uid ê²€ì¦
        String actualMerchantUid = paymentInfo.get("merchant_uid").asText();
        if (!merchantUid.equals(actualMerchantUid)) {
            log.error("ì£¼ë¬¸ë²ˆí˜¸ ë¶ˆì¼ì¹˜: expected={}, actual={}", merchantUid, actualMerchantUid);
            return false;
        }
        
        // ê²°ì œ ìƒíƒœ ê²€ì¦
        String status = paymentInfo.get("status").asText();
        if (!"paid".equals(status)) {
            log.error("ê²°ì œ ìƒíƒœ ì˜¤ë¥˜: status={}", status);
            return false;
        }
        
        // ê²°ì œ ê¸ˆì•¡ ê²€ì¦
        BigDecimal actualAmount = paymentInfo.get("amount").decimalValue();
        if (expectedAmount.compareTo(actualAmount) != 0) {
            log.error("ê²°ì œ ê¸ˆì•¡ ë¶ˆì¼ì¹˜: expected={}, actual={}", expectedAmount, actualAmount);
            return false;
        }
        
        return true;
    }
```
- í•´ì„œ verifyPaymentë¥¼ í˜¸ì¶œí•˜ë©´ ì´ ê²€ì¦ ì ˆì°¨ë¥¼ ë‹¤ ì§„í–‰í•´ì¤€ë‹¤.
```java
@Override
    public boolean verifyPayment(String impUid, String merchantUid, BigDecimal expectedAmount) throws Exception {
        try {
            // 1. ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰
            String accessToken = getAccessToken();
            
            // 2. ê²°ì œ ì •ë³´ ì¡°íšŒ
            JsonNode paymentInfo = getPaymentInfo(accessToken, impUid);
            
            // 3. ê²°ì œ ì •ë³´ ê²€ì¦
            return validatePaymentInfo(paymentInfo, merchantUid, expectedAmount);
            
        } catch (Exception e) {
            log.error("ì•„ì„í¬íŠ¸ ê²°ì œ ê²€ì¦ ì‹¤íŒ¨: impUid={}, merchantUid={}, expectedAmount={}", 
                    impUid, merchantUid, expectedAmount, e);
            throw new Exception("ê²°ì œ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", e);
        }
    }
```
- ê²°ì œëŠ” ê²°ì œ ë²„íŠ¼ì„ ëˆ„ë¥´ìë§ˆì ajaxë¡œ ê²°ì œë¥¼ ì‹¤í–‰í•œë‹¤.
- ì¶”ê°€í•œ scriptê°€ ìˆìœ¼ë©´ IMPë¥¼ ì‚¬ìš©ê°€ëŠ¥í•˜ë‹¤. window.IMPì´ë‹¤.
- ì´ë¥¼ ë‚˜í•œí…Œ ë¶€ì—¬ëœ MP.init('imp06xxxxxx'); // ê³ ê°ì‚¬ ì‹ë³„ì½”ë“œë¥¼ ì…ë ¥í•´ì„œ ì´ˆê¸°í™”í•œë‹¤.
- ê·¸ë¦¬ê³  IMP.request_payë¥¼ í™œìš©í•˜ì—¬ ì œì‹œí•˜ëŠ” ì •ë³´ë“¤ì„ ì±„ì›Œì£¼ë©´ ëœë‹¤.'
- ê²°ì œì— ì„±ê³µí•˜ë©´ await completePayment(orderNumber, deliveryMemo, paymentMethod.value, rsp);ë¥¼ í†µí•´ ì„±ê³µì •ë³´ë¥¼ ë°±ì—”ë“œë¡œ ë³´ë‚´ì¤€ë‹¤. ì´ëŠ” í•˜ë‚˜ ë” ì•„ë˜ ì½”ë“œì´ë‹¤.
```js
// ê²°ì œí•˜ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
if (paymentButton) {
    paymentButton.addEventListener('click', async function(e) {
        e.preventDefault();
        
        // ìœ íš¨ì„± ê²€ì‚¬
        if (!validatePaymentForm()) {
            return;
        }
        
        try {
            // ì£¼ë¬¸ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸° -> URL íŒŒë¼ë¯¸í„°ì—ì„œ
            const urlParams = new URLSearchParams(window.location.search);
            const orderNumber = urlParams.get('orderNumber');
            
            if (!orderNumber) {
                alert('ì£¼ë¬¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ë°°ì†¡ ë©”ëª¨ ì„¤ì •
            let deliveryMemo = deliveryMemoSelect.value;
            if (deliveryMemo === 'ì§ì ‘ì…ë ¥') {
                deliveryMemo = customMemoInput.value;
            } else if (deliveryMemo === '' || deliveryMemo === 'ë°°ì†¡ë©”ëª¨ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.') {
                deliveryMemo = null;
            }
            
            // ê²°ì œ ë°©ë²• ê°€ì ¸ì˜¤ê¸°
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
            if (!paymentMethod) {
                alert('ê²°ì œ ë°©ë²•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì•„ì„í¬íŠ¸ ê²°ì œ ë°©ë²• ë§¤í•‘
            let pgMethod = '';
            switch(paymentMethod.value) {
                case 'ì‹ ìš©ì¹´ë“œ':
                    pgMethod = 'card';
                    break;
                case 'ê°€ìƒê³„ì¢Œ':
                    pgMethod = 'vbank';
                    break;
                case 'ì‹¤ì‹œê°„ê³„ì¢Œì´ì²´':
                    pgMethod = 'trans';
                    break;
                default:
                    pgMethod = 'card';
            }
            
            // ì´ ê²°ì œ ê¸ˆì•¡ ê°€ì ¸ì˜¤ê¸° (data ì†ì„±ì—ì„œ ì¶”ì¶œ)
            const totalAmount = parseInt(paymentButton.dataset.amount) || 0;
            
            if (totalAmount <= 0) {
                alert('ê²°ì œ ê¸ˆì•¡ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì•„ì„í¬íŠ¸ ì´ˆê¸°í™”
            const IMP = window.IMP;
            IMP.init('mp06xxxxxx'); // ê³ ê°ì‚¬ ì‹ë³„ì½”ë“œ
            
            // ê²°ì œ ìš”ì²­
            IMP.request_pay({
                pg: 'uplus', // (êµ¬) í† ìŠ¤í˜ì´ë¨¼ì¸ 
                pay_method: pgMethod,
                merchant_uid: orderNumber, // ì£¼ë¬¸ë²ˆí˜¸ë¥¼ merchant_uidë¡œ ì‚¬ìš©
                name: 'ìƒí’ˆ ì£¼ë¬¸', // ê²°ì œëª…
                amount: totalAmount, // ê²°ì œê¸ˆì•¡
                buyer_email: ordererEmailEl ? ordererEmailEl.value : '',
                buyer_name: receiverNameEl.value,
                buyer_tel: receiverPhoneEl.value,
                buyer_addr: addressEl.value + ' ' + detailAddressEl.value,
                buyer_postcode: postcodeEl.value
            }, async function(rsp) {
                if (rsp.success) {
                    // ê²°ì œ ì„±ê³µ
                    console.log('ê²°ì œ ì„±ê³µ:', rsp);
                    
                    // ì„œë²„ì— ê²°ì œ ì™„ë£Œ ì •ë³´ ì „ì†¡
                    await completePayment(orderNumber, deliveryMemo, paymentMethod.value, rsp);
                } else {
                    // ê²°ì œ ì‹¤íŒ¨
                    console.log('ê²°ì œ ì‹¤íŒ¨:', rsp);
                    alert('ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.\n' + rsp.error_msg);
                }
            });
            
        } catch (error) {
            console.error('ê²°ì œ ìš”ì²­ ì‹¤íŒ¨:', error);
            alert('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
    });
}
```
- ê¸°ì¡´ì— ìˆë˜ ê²°ì œ ì™„ë£Œ ì²˜ë¦¬ í•¨ìˆ˜ì´ë‹¤. í˜¹ì‹œ í•„ìš”í•  ìˆ˜ë„ ìˆìœ¼ë‹ˆ ê²°ì œ ì •ë³´ë¥¼ í¬í•¨í•˜ì—¬ ì „ë‹¬í•˜ì˜€ë‹¤.
```js
// ê²°ì œ ì™„ë£Œ ì²˜ë¦¬ í•¨ìˆ˜
async function completePayment(orderNumber, deliveryMemo, paymentMethod, paymentResponse) {
    try {
        // ì•½ê´€ ë™ì˜ í™•ì¸
        const purchaseTerm = Array.from(document.querySelectorAll('.detail-agree[data-required="true"]')).every(cb => cb.checked);
        
        // ë°°ì†¡ë¹„ ê°€ì ¸ì˜¤ê¸° (hidden inputì—ì„œ)
        const deliveryPriceEl = document.getElementById('deliveryPrice');
        const deliveryPrice = deliveryPriceEl ? parseInt(deliveryPriceEl.value) || 0 : 0;
        
        // FormData ìƒì„±
        const formData = new FormData();
        formData.append('orderNumber', orderNumber);
        formData.append('receiverName', receiverNameEl.value);
        formData.append('receiverPhone', receiverPhoneEl.value);
        formData.append('receiverPostcode', postcodeEl.value);
        formData.append('receiverAddress', addressEl.value);
        formData.append('receiverDetailAddress', detailAddressEl.value);
        formData.append('deliveryMemo', deliveryMemo);
        formData.append('paymentMethod', paymentMethod);
        formData.append('purchaseTerm', purchaseTerm);
        formData.append('deliveryPrice', deliveryPrice);
        
        // ì•„ì„í¬íŠ¸ ê²°ì œ ì •ë³´ ì¶”ê°€
        formData.append('impUid', paymentResponse.imp_uid);
        formData.append('merchantUid', paymentResponse.merchant_uid);
        formData.append('paidAmount', paymentResponse.paid_amount);
        
        // ê²°ì œ ì™„ë£Œ API í˜¸ì¶œ
        const response = await fetch('/api/payment/complete', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            // ì„±ê³µ í˜ì´ì§€ë¡œ ì´ë™ 
            window.location.href = `/payment/success?orderNumber=${orderNumber}`;
        } else {
            // ì„œë²„ ì¸¡ ìœ íš¨ì„± ê²€ì‚¬ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
            alert(result.message || 'ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
        
    } catch (error) {
        console.error('ê²°ì œ ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        alert('ê²°ì œ ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê³ ê°ì„¼í„°ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
    }
}
```

### ğŸ“Œ 0-3. ê²°ì œ ì·¨ì†Œ ì‹œì— ê²°ì œ ìƒíƒœ ì—…ë°ì´íŠ¸í•˜ë„ë¡ í•˜ê¸°
- ì•„ì„í¬íŠ¸ ê²°ì œ ìƒíƒœì˜ íŠ¹ì„±
- ready: ê²°ì œ ì¤€ë¹„ë¨ (ì‚¬ìš©ìê°€ ê²°ì œì°½ì—ì„œ ì§„í–‰ ì¤‘)
- paid: ê²°ì œ ì™„ë£Œ
- cancelled: ê²°ì œ ì·¨ì†Œ
- failed: ê²°ì œ ì‹¤íŒ¨
- ì´ë•Œ ë¹ ë¥´ê²Œ ê²°ì œê°€ ë˜ë©´ ë°”ë¡œ paid ìƒíƒœê°€ ë˜ì–´ ì²˜ìŒ if (!"paid".equals(status)) return false;ì—ì„œ ì´ë¥¼ í†µê³¼í•  ìˆ˜ ìˆì—ˆë‹¤.
- ê·¸ëŸ°ë° ê³„ì¢Œì´ì²´/ê°€ìƒê³„ì¢Œ ê°™ì€ ê²½ìš°ëŠ” ready ìƒíƒœê°€ ë” ì˜¤ë˜ ì§€ì†ë˜ì–´ ê²°ì œê°€ ë°”ë¡œ ì´ë£¨ì–´ì§€ì§€ ì•Šìœ¼ë¯€ë¡œ ready ìƒíƒœë¡œ ìˆì—ˆë‹¤.
- ê·¸ë˜ì„œ ë¹ ë¥´ê²Œ ì²˜ë¦¬ë˜ëŠ” ê²½ìš°ì—ë§Œ ì„±ê³µí•˜ê³ , ì¡°ê¸ˆì´ë¼ë„ ì§€ì—°ë˜ë©´ ì‹¤íŒ¨í–ˆë˜ ê²ƒì´ë‹¤.
- ì•„ë˜ëŠ” í•´ë‹¹ ê²°ì œ ê²€ì¦ ë¡œì§ì´ë‹¤. ì•ì„œ ë°œê¸‰ëœ í† í°ì„ í™œìš©í•˜ì—¬ ê²°ì œ ìš”ì²­ì´í›„ ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ë©´ ê·¸ ì‚¬ìš©ì ì •ë³´ë¥¼ í† ëŒ€ë¡œ ì•„ë˜ ê²€ì¦ë¡œì§ì„ í˜¸ì¶œí–ˆì—ˆë‹¤.
- if (!"paid".equals(status) && !"ready".equals(status)) ì´ë ‡ê²Œ ìˆ˜ì •í•˜ì—¬ ready ìƒíƒœì—ì„œë„ ìš°ì„  ê²°ì œ ìì²´ê°€ í†µê³¼í•  ìˆ˜ ìˆë„ë¡ í•˜ì˜€ë‹¤.
- í†µê³¼í•˜ë©´ ê¸ˆì•¡ì´ ë§ëŠ”ì§€ë§Œ ê²€ì¦í•˜ê³  ê²°ê³¼ë¥¼ booleanìœ¼ë¡œ ë°˜í™˜í•œë‹¤.
```java
 /**
     * ê²°ì œ ì •ë³´ ê²€ì¦
     * 
     * @param paymentInfo - ì¡°íšŒëœ ê²°ì œ ì •ë³´
     * @param merchantUid - ê°€ë§¹ì  ì£¼ë¬¸ë²ˆí˜¸
     * @param expectedAmount - ì˜ˆìƒ ê²°ì œ ê¸ˆì•¡
     * @return boolean - ê²€ì¦ ì„±ê³µ ì—¬ë¶€
     */
    private boolean validatePaymentInfo(JsonNode paymentInfo, String merchantUid, BigDecimal expectedAmount) {
        // merchant_uid ê²€ì¦
        String actualMerchantUid = paymentInfo.get("merchant_uid").asText();
        if (!merchantUid.equals(actualMerchantUid)) {
            return false;
        }
        
        // ê²°ì œ ìƒíƒœ ê²€ì¦
        String status = paymentInfo.get("status").asText();
        
        // paid(ê²°ì œì™„ë£Œ) ë˜ëŠ” ready(ê²°ì œì¤€ë¹„ì¤‘) ìƒíƒœë§Œ í—ˆìš©
        // ready ìƒíƒœëŠ” ì‚¬ìš©ìê°€ ì•„ì§ ê²°ì œë¥¼ ì§„í–‰ ì¤‘ì¸ ìƒíƒœì´ë¯€ë¡œ ì •ìƒì ì¸ ìƒíƒœì„
        if (!"paid".equals(status) && !"ready".equals(status)) {
            return false;
        }
        
        // ê¸ˆì•¡ ê²€ì¦
        BigDecimal actualAmount = paymentInfo.get("amount").decimalValue();
        if (expectedAmount.compareTo(actualAmount) != 0) {
            return false;
        }
        
        return true;
    }
```
- ì—¬ê¸°ê¹Œì§€ í•˜ë©´ ì•„ë˜ ê²€ì¦ ì ˆì°¨ì—ì„œ 3ë²ˆê¹Œì§€ ì™„ë£Œëœ ê²ƒì´ë‹¤. ì´ì œ ì•„ë˜ 4ë²ˆì—ì„œ ê²€ì¦ì— ì‹¤íŒ¨í–ˆì„ ê²½ìš° ì²˜ë¦¬ë¥¼ ì‚´í´ë³´ë©´ ëœë‹¤.
```java
/**
     * ì•„ì„í¬íŠ¸ ê²°ì œ ê²€ì¦
     * 
     * @param impUid - ì•„ì„í¬íŠ¸ ê²°ì œ ê³ ìœ  ID
     * @param merchantUid - ê°€ë§¹ì  ì£¼ë¬¸ë²ˆí˜¸
     * @param expectedAmount - ì˜ˆìƒ ê²°ì œ ê¸ˆì•¡
     * @return boolean - ê²€ì¦ ì„±ê³µ ì—¬ë¶€
     * @throws Exception - ê²€ì¦ ì‹¤íŒ¨ ì‹œ
     */
    @Override
    public boolean verifyPayment(String impUid, String merchantUid, BigDecimal expectedAmount) throws Exception {
        
            // 1. ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰
            String accessToken = getAccessToken();
            
            // 2. ê²°ì œ ì •ë³´ ì¡°íšŒ
            JsonNode paymentInfo = getPaymentInfo(accessToken, impUid);
            String paymentStatus = paymentInfo.get("status").asText();
            
            // 3. ê²°ì œ ì •ë³´ ê²€ì¦
            boolean isValid = validatePaymentInfo(paymentInfo, merchantUid, expectedAmount);
            
            // 4. ê²€ì¦ ê²°ê³¼ì— ë”°ë¥¸ ì²˜ë¦¬
            if (!isValid) {
                if ("paid".equals(paymentStatus)) {
                    // ê²°ì œ ì™„ë£Œëœ ê²½ìš°ì—ë§Œ ì·¨ì†Œ API í˜¸ì¶œ
                    cancelPayment(accessToken, impUid, "ê²°ì œ ê²€ì¦ ì‹¤íŒ¨");
                }
                // ê²°ì œ ìƒíƒœì™€ ê´€ê³„ì—†ì´ ì£¼ë¬¸ ìƒíƒœëŠ” í•­ìƒ 'ì·¨ì†Œì™„ë£Œ'ë¡œ ì—…ë°ì´íŠ¸
                updateOrderStatusToCancelled(merchantUid);

                return false;
            }

            return true;
    }
```
- String url = IAMPORT_API_URL + "/payments/cancel"; ì—¬ê¸°ì„œ "/payments/cancel" ì´ urlì„ í†µí•´ ì´ ìš”ì²­ì´ ì·¨ì†Œìš”ì²­ì„ì„ ì•Œê²Œëœë‹¤.
- ê²°ì œ ê³ ìœ  ì•„ì´ë””(imp_uid)ë¥¼ ë³´ë‚´ì„œ í•´ë‹¹ ê²°ì œë¥¼ ì·¨ì†Œí•œë‹¤. 
- ê²°ì œ ê³ ìœ  ì•„ì´ë””ëŠ” jsì—ì„œ ê²°ì œ ìš”ì²­ì— ëŒ€í•œ ì„±ê³µ ì‘ë‹µì— í¬í•¨ëœ imp_uidë¥¼ ë½‘ì•„ì„œ formData.append('impUid', paymentResponse.imp_uid);ë¡œ ì €ì¥í•´ì„œ ë°±ì—”ë“œë¡œ ë³´ë‚¼ë•Œ í•¨ê»˜ë³´ë‚´ì˜¨ë‹¤.
- ì´ëŠ” ê²°ì œê°€ ì™„ë£Œëœ ì¦‰ paid ìƒíƒœì¼ë•Œë§Œ ì‘ë™í•œë‹¤.
```java
/**
     * ì•„ì„í¬íŠ¸ ê²°ì œ ì·¨ì†Œ
     * 
     * @param accessToken - ì•¡ì„¸ìŠ¤ í† í°
     * @param impUid - ì•„ì„í¬íŠ¸ ê²°ì œ ê³ ìœ  ID
     * @param reason - ì·¨ì†Œ ì‚¬ìœ 
     * @throws Exception - ì·¨ì†Œ ì‹¤íŒ¨ ì‹œ
     */
    private void cancelPayment(String accessToken, String impUid, String reason) throws Exception {
        String url = IAMPORT_API_URL + "/payments/cancel";
        
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);
        headers.set("Authorization", "Bearer " + accessToken);
        
        MultiValueMap<String, String> body = new LinkedMultiValueMap<>();
        body.add("imp_uid", impUid);
        body.add("reason", reason);
        
        HttpEntity<MultiValueMap<String, String>> request = new HttpEntity<>(body, headers);
        
        ResponseEntity<String> response = restTemplate.postForEntity(url, request, String.class);
        JsonNode jsonNode = objectMapper.readTree(response.getBody());
        
        if (jsonNode.get("code").asInt() != 0) {
            throw new InternalServerErrorException("ê²°ì œ ì·¨ì†Œ ì‹¤íŒ¨: " + jsonNode.get("message").asText());
        }
    }
```
- ê·¸ë¦¬ê³  ì·¨ì†Œê°€ ì´ë£¨ì–´ì§€ëŠ” ëª¨ë“  ìƒíƒœì—ì„œ ì•„ë˜ë¥¼ í˜¸ì¶œí•˜ì—¬ mapperì—ì„œ ì£¼ë¬¸ì˜ ìƒíƒœë¥¼ ì·¨ì†Œì™„ë£Œë¡œ ì—…ë°ì´íŠ¸í•œë‹¤.
```java
/**
     * ì£¼ë¬¸ ìƒíƒœë¥¼ 'ì·¨ì†Œì™„ë£Œ'ë¡œ ì—…ë°ì´íŠ¸
     * 
     * @param merchantUid - ê°€ë§¹ì  ì£¼ë¬¸ë²ˆí˜¸ (ì£¼ë¬¸ë²ˆí˜¸)
     * @throws Exception - ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ ì‹œ
     */
    @Transactional(rollbackFor = Exception.class)
    private void updateOrderStatusToCancelled(String merchantUid) throws Exception {
        
        // ì£¼ë¬¸ë²ˆí˜¸ë¡œ ì£¼ë¬¸ ì •ë³´ ì¡°íšŒí•˜ì—¬ orderId íšë“
        Order searchOrder = new Order();
        searchOrder.setOrderNumber(merchantUid);
        
        Order existingOrder = orderMapper.selectByOrderNumber(searchOrder);
        if (existingOrder == null) {
            throw new InternalServerErrorException("ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: í•´ë‹¹ ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. orderNumber=" + merchantUid);
        }
        
        // orderIdë¥¼ ì‚¬ìš©í•˜ì—¬ ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸
        Order updateOrder = new Order();
        updateOrder.setOrderId(existingOrder.getOrderId());
        updateOrder.setOrderStatus("ì·¨ì†Œì™„ë£Œ");
        
        int updatedRows = orderMapper.updateStatus(updateOrder);

        if (updatedRows == 0) {
            throw new InternalServerErrorException("ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ì—…ë°ì´íŠ¸ëœ í–‰ì´ ì—†ìŠµë‹ˆë‹¤. orderNumber=" + merchantUid);
        }
    }
```

### ğŸ“Œ 0-4. ê²°ì œì •ë³´ application propirtiesì— ë¶„ë¦¬
- ì•„ì„í¬íŠ¸ì™€ ê´€ë ¨ëœ ëª¨ë“  ì •ë³´ë¥¼ ì„¤ì • íŒŒì¼ë¡œ ë¹¼ê³  ì´ë¥¼ viewë¥¼ ë„ìš¸ë•Œ ê²°ì œ ë²„íŠ¼ì— datasetìœ¼ë¡œ ë°•ì•„ë‘ê³  ì´ë¥¼ jsì—ì„œ ì½ì–´ì„œ ì‚¬ìš©í•˜ì˜€ë‹¤.
```html
<!-- ê²°ì œ ë²„íŠ¼ -->
<button id="paymentButton" class="pay-btn my-btn big-btn black-btn" 
        th:data-amount="${orderSummary.finalPrice}"
        th:data-iamport-code="${iamportMerchantCode}"
        th:data-pg-provider="${paymentPgProvider}"
        th:data-order-name="${paymentOrderName}">
    <span th:text="${#numbers.formatDecimal(orderSummary.finalPrice, 0, 'COMMA', 0, 'POINT')} + 'ì› ê²°ì œí•˜ê¸°'"></span>
</button>
```
- ë¯¼ê°ì •ë³´ ê°€ë¦¬ê¸°, íŒ€ì›ë“¤ì´ ë‚˜ì¤‘ì— ì•„ì„í¬íŠ¸ ê³„ì •ì„ ë§Œë“¤ì–´ì„œ í…ŒìŠ¤íŠ¸í•  ê²ƒì„ ê°ì•ˆí•œ ì²˜ë¦¬ì˜€ë‹¤.
```js
const IMP = window.IMP;
    const iamportCode = paymentButton.dataset.iamportCode;
    const pgProvider = paymentButton.dataset.pgProvider;
    const orderName = paymentButton.dataset.orderName;
    IMP.init(iamportCode); // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ê³ ê°ì‚¬ ì‹ë³„ì½”ë“œ ì‚¬ìš©

    // ê²°ì œ ìš”ì²­
    IMP.request_pay({
        pg: pgProvider, // ì„œë²„ì—ì„œ ì „ë‹¬ëœ PG ì œê³µì ì‚¬ìš©
        pay_method: pgMethod,
        merchant_uid: orderNumber, // ì£¼ë¬¸ë²ˆí˜¸ë¥¼ merchant_uidë¡œ ì‚¬ìš©
        name: orderName, // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ê²°ì œëª… ì‚¬ìš©
        amount: totalAmount, // ê²°ì œê¸ˆì•¡
        buyer_email: ordererEmailEl ? ordererEmailEl.value : '',
        buyer_name: receiverNameEl.value,
        buyer_tel: receiverPhoneEl.value,
        buyer_addr: addressEl.value + ' ' + detailAddressEl.value,
        buyer_postcode: postcodeEl.value
    }, async function(rsp) {
        if (rsp.success) {
            // ê²°ì œ ì„±ê³µ
            console.log('ê²°ì œ ì„±ê³µ:', rsp);
            
            // ì„œë²„ì— ê²°ì œ ì™„ë£Œ ì •ë³´ ì „ì†¡
            await completePayment(orderNumber, deliveryMemo, paymentMethod.value, rsp);
        } else {
            // ê²°ì œ ì‹¤íŒ¨
            console.log('ê²°ì œ ì‹¤íŒ¨:', rsp);
            alert('ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.\n' + rsp.error_msg);
        }
    });
```

### ğŸ“Œ 0-5. êµ¬ë§¤ì ì •ë³´ ê²€ì¦
- dbì— ìˆë˜ êµ¬ë§¤ì ì •ë³´ë¥¼ ê²°ì œ ì™„ë£Œ í›„ ë°˜í™˜ëœ ì •ë³´ì˜ í‹€ì— ë§ì¶°ì„œ ë¹„êµí•˜ì—¬ ê²€ì¦ ë¡œì§ì„ ê°•í™”í•˜ì˜€ë‹¤.
```java
/**
     * êµ¬ë§¤ì ì •ë³´ ê²€ì¦
     * 
     * @param paymentInfo - ì¡°íšŒëœ ê²°ì œ ì •ë³´
     * @param buyerName - êµ¬ë§¤ì ì´ë¦„
     * @param buyerTel - êµ¬ë§¤ì ì „í™”ë²ˆí˜¸
     * @param buyerEmail - êµ¬ë§¤ì ì´ë©”ì¼
     * @param buyerAddr - êµ¬ë§¤ì ì£¼ì†Œ
     * @param buyerPostcode - êµ¬ë§¤ì ìš°í¸ë²ˆí˜¸
     * @return boolean - ê²€ì¦ ì„±ê³µ ì—¬ë¶€
     */
    private boolean validateBuyerInfo(JsonNode paymentInfo, String buyerName, String buyerTel, String buyerEmail, String buyerAddr, String buyerPostcode) {
        
            // ì•„ì„í¬íŠ¸ APIì—ì„œ ë°˜í™˜ë˜ëŠ” êµ¬ë§¤ì ì •ë³´ í•„ë“œë“¤
            String actualBuyerName = paymentInfo.get("buyer_name") != null ? paymentInfo.get("buyer_name").asText() : "";
            String actualBuyerTel = paymentInfo.get("buyer_tel") != null ? paymentInfo.get("buyer_tel").asText() : "";
            String actualBuyerEmail = paymentInfo.get("buyer_email") != null ? paymentInfo.get("buyer_email").asText() : "";
            String actualBuyerAddr = paymentInfo.get("buyer_addr") != null ? paymentInfo.get("buyer_addr").asText() : "";
            String actualBuyerPostcode = paymentInfo.get("buyer_postcode") != null ? paymentInfo.get("buyer_postcode").asText() : "";
            
            // êµ¬ë§¤ì ì´ë¦„ ê²€ì¦ (í•„ìˆ˜)
            if (!buyerName.equals(actualBuyerName)) {
                return false;
            }
            
            // êµ¬ë§¤ì ì „í™”ë²ˆí˜¸ ê²€ì¦ (í•„ìˆ˜)
            if (!buyerTel.equals(actualBuyerTel)) {
                return false;
            }
            
            // êµ¬ë§¤ì ì´ë©”ì¼ ê²€ì¦
            if (buyerEmail != null && !buyerEmail.isEmpty() && !buyerEmail.equals(actualBuyerEmail)) {
                return false;
            }
            
            // êµ¬ë§¤ì ì£¼ì†Œ ê²€ì¦ (í•„ìˆ˜)
            if (!buyerAddr.equals(actualBuyerAddr)) {
                return false;
            }
            
            // êµ¬ë§¤ì ìš°í¸ë²ˆí˜¸ ê²€ì¦ (í•„ìˆ˜)
            if (!buyerPostcode.equals(actualBuyerPostcode)) {
                return false;
            }

            return true;
    }
```

### ğŸ“Œ 0-6. ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ë¬¸ì œí•´ê²° & ì˜¤ë²„ë ˆì´ ë“œë˜ê·¸ í´ë¦­ë°©ì§€ 
- const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth; : ë¸Œë¼ìš°ì € ìŠ¤í¬ë¡¤ë°”ì˜ ì „ì²´ë„“ì´ - ì»¨í…ì¸  ë„“ì´ = ìŠ¤í¬ë¡¤ë°” ë„“ì´
- document.body.style.paddingRight = scrollbarWidth + 'px'; : ìœ„ì—ì„œ ê³„ì‚°í•œ ìŠ¤í¬ë¡¤ë°” ë„“ì´ë§Œí¼ bodyì— paddding right ì¶”ê°€
- ì´ë¥¼ ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ë¼ê³  í•œë‹¤. (ë ˆì´ì•„ì›ƒì´ ì´ë™í•˜ë‹¤.)
- ê·¸ë¦¬ê³  ë‹«ì„ ë•Œ ê¼­ íŒ¨ë”©ì„ ë¦¬ì…‹ì‹œì¼œì£¼ì–´ì•¼í•œë‹¤.
```js
 // ëª¨ë‹¬ ë„ìš°ê³  ìŠ¤í¬ë¡¤ ë§‰ê¸° (ë ˆì´ì•„ì›ƒ ì‹œí”„íŠ¸ ë°©ì§€)
        const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
        document.body.style.paddingRight = scrollbarWidth + 'px';
        modalOverlayProfile.style.display = 'flex';
        document.body.classList.add('modal-open');

document.body.style.paddingRight = '';
```
- 
```js
// ì˜¤ë²„ë ˆì´ ì˜ì—­ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸° (ë“œë˜ê·¸ ë°©ì§€)
let mouseDownOnOverlay = false;

modalOverlayProfile.addEventListener('mousedown', e => {
    if (e.target === e.currentTarget) {
        mouseDownOnOverlay = true;
        e.preventDefault(); // ë“œë˜ê·¸ë¡œ ì¸í•œ ë°°ê²½ ë°€ë¦¼ ë°©ì§€
    }
});

modalOverlayProfile.addEventListener('mouseup', e => {
    if (e.target === e.currentTarget && mouseDownOnOverlay) {
        modalOverlayProfile.style.display = 'none';
        document.body.classList.remove('modal-open');
        clearProfileForm();
    }
    mouseDownOnOverlay = false;
});

// ë§ˆìš°ìŠ¤ê°€ ì˜¤ë²„ë ˆì´ë¥¼ ë²—ì–´ë‚˜ë©´ ë¦¬ì…‹
modalOverlayProfile.addEventListener('mouseleave', () => {
    mouseDownOnOverlay = false;
});

// ë“œë˜ê·¸ ì´ë²¤íŠ¸ ìì²´ë¥¼ ì°¨ë‹¨í•˜ì—¬ ë°°ê²½ ë°€ë¦¼ ì™„ì „ ë°©ì§€
modalOverlayProfile.addEventListener('dragstart', e => {
    e.preventDefault();
});
```