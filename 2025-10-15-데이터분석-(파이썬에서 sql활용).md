# 📌 1. 파이썬에서 SQL 활용
### 1-1. sql 연결
- 해당 db를 코랩에 만들어서 바로 사용할 수 있고 아래 connection 객체를 통해서 코랩에 만들어둔 db에 접속한다. 해당 db가 없으면 새로 만든다.
- cursor는 쿼리를 sql에 실어나르고 값을 받아서 가져오는 역할을 하는 객체이다.
```py
import sqlite3
# connection 객체를 생성 # conn.close()로 채널 닫기
conn = sqlite3.connect('sqlite_test.db')
cursor = conn.cursor() # sql을 태워보낼 cursor를 만든다.
```

### 1-2. execute 명령어로 sql 쿼리 입력하기
```py
# 테이블 생성
cursor.execute('CREATE TABLE contact(name text, age int, email text)')

# 데이터 삽입 1
conn.execute("INSERT INTO contact VALUES('kim', 20, 'kim@megait.edu')")
conn.execute("INSERT INTO contact VALUES('lee', 40, 'lee@macademy.org')")
conn.execute("INSERT INTO contact VALUES('park', 60, 'park@daum.net')")

# 데이터 삽입 2
input_data = (
    ('홍', 25, 'hong@naver.com'),
    ('강', 34, 'kang@yes.kr'),
    ('진', 56, 'jin@mail.com'),
)

sql = "INSERT INTO contact(name, age, email) values (?, ?, ?)"

cursor.executemany(sql, input_data)

# 모든 작업이 완료되면 커밋해야 db에 반영된다.
conn.commit()

# 취소하려면 rollback 수행
conn.rollback()
# 데이터베이스 종료: connection 연결 종료
conn.close()
```
- fetchone는 현재 커서 위치에서 한행만 가져오기이고
- fetchall는 모든 행 가져오기 이다.
```py
cursor.fetchone()
cursor.fetchall()
```

### 1-3. 주식정보 가져와서 데이터베이스에 저장하기
- df_hynix = fdr.DataReader('000660', '20150901',"20151015")에서 주식코드와 기간을 입력하여서 해당 주식 정보를 가져온다.
```py
import sqlite3
import pandas as pd
import pandas_datareader as pdr
import FinanceDataReader as fdr

df_krx = fdr.StockListing('KRX')
df_hynix = fdr.DataReader('000660', '20150901',"20151015")

conn = sqlite3.connect('kosphi_hynix.db')
cur = conn.cursor()
```
- 아래 명령을 통해 연결된 conn를 타고 해당 데이터 베이스에 hynix라는 테이블을 만들고 해당 데이터 프레임의 데이터를 밀어넣는다.
```py
df_hynix.to_sql('hynix', conn, if_exists='replace')
```
- 읽어들일 때는 pandas의 read_sql을 활용하여 select 구문을 넣어서 해당 데이터를 가져온다.
- 이때 connection 객체를 넘겨야한다.
```py
pd.read_sql("select * from hynix", conn)
```

### 1-4. sql 추가 실습
- 모든 테이블의 정보를 담고 있는 meta table이 모든 db에 다 있다
- 여기에선 sqlite_master이다.
- """를 활용하여 쿼리의 가독성을 높일 수 있다.
```py
import pandas as pd
conn = sqlite3.connect('pandas-transaction.db')
query = "select * from 'sqlite_master'"       # 해당 DB에서 전체 Master 되는 Table 들 조회시 사용
pd.read_sql(query, conn)

# 아래처럼 쿼리를 바꿔가면서 원하는 것을 조회하면 된다.

query = 
"""select Name, Age, Sex, email, rank() over(order by Age) 
from 'user' 
order by Name asc"""       # 해당 DB에서 전체 Master 되는 Table 들 조회시 사용
pd.read_sql(query, conn)
```