# ğŸ“Œ 0. ë³´ìŠ¤ í´ë¡  ì½”ë”© í”„ë¡œì íŠ¸
### ğŸ“Œ 0-1. securityRandomì‚¬ìš©í•´ì„œ ë¹„ë°€ë²ˆí˜¸ ì¬ë°œê¸‰ êµ¬í˜„
- java.security.SecureRandomì€ ì‹œìŠ¤í…œì˜ ì—”íŠ¸ë¡œí”¼(ë§ˆìš°ìŠ¤ ì›€ì§ì„, ì‹œê°„ ë“± ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ìš”ì†Œ)ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‚œìˆ˜ë¥¼ ë§Œë“¤ì–´ ì˜ˆì¸¡ì´ ë§¤ìš° ì–´ë µê³  ì¼ë°˜ java.utilì˜ randomë³´ë‹¤ ë³´ì•ˆì„±ì´ ë†’ë‹¤.
- ëœë¤ í´ë˜ìŠ¤ì˜ nextInt ë©”ì„œë“œëŠ” 0ë¶€í„° ì¸ìë¡œ ì¤€ ìˆ˜ë³´ë‹¤ ì‘ì€ ìˆ˜ ì¤‘ì—ì„œ ëœë¤ìœ¼ë¡œ í•˜ë‚˜ë¥¼ ë½‘ëŠ”
```java
// ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ìƒì„±(8ìë¦¬: ì˜ë¬¸, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì í¬í•¨)
        String chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
        String nums = "0123456789";
        SecureRandom  rnd = new SecureRandom();
        String newPassword = null;

        while (true) {
            StringBuilder sb = new StringBuilder();
            // ì˜ë¬¸ì 1ê°œ ë¬´ì¡°ê±´ í¬í•¨
            sb.append(chars.charAt(rnd.nextInt(chars.length())));
            // ìˆ«ì 1ê°œ ë¬´ì¡°ê±´ í¬í•¨
            sb.append(nums.charAt(rnd.nextInt(nums.length())));

            // ë‚˜ë¨¸ì§€ 6ìë¦¬ëŠ” ì˜ë¬¸/ìˆ«ì ì„ì–´ì„œ ëœë¤ ìƒì„±
            String all = chars + nums;
            for (int i = 0; i < 6; i++) {
                sb.append(all.charAt(rnd.nextInt(all.length())));
            }
        }
```

### ğŸ“Œ 0-2. ë©”ì¼ ë³´ë‚´ëŠ” ë™ì•ˆ ë¡œë”©ë°” ë„ìš°ê¸°
```html
<!-- ë©”ì¼ ë³´ë‚¼ ë•Œ ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ ë„ìš¸ ë¡œë”©ë°” -->
<div id="loading-overlay" style="display:none;">
    <img th:src="@{/assets/img/login/loading.gif}" alt="ë¡œë”© ì¤‘" class="loading-gif" />
    <p class="loading-msg">ë©”ì¼ì„ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤â€¦</p>
</div>
```
```css
#loading-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: rgba(255,255,255,0.6);
    backdrop-filter: blur(2px);

    .loading-gif {
    width: 60px;
    height: 60px;
    margin-bottom: 12px;
    }
    .loading-msg {
        font-size: 14px;
        color: #222;
    }
}
```
```js
/**
 *  ë©”ì¼ ë³´ë‚¼ ë•Œ ë¡œë”©ë°” í‘œì‹œí•¨ìˆ˜
 * @param {string} msg - ë¡œë”© ë©”ì‹œì§€ (ê¸°ë³¸ê°’: 'ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤â€¦')
 */
function showLoading(msg = 'ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤â€¦') {
    const overlay = document.getElementById('loading-overlay');
    overlay.style.display = 'flex';
    overlay.querySelector('.loading-msg').textContent = msg;
}

/**
 * ë©”ì¼ ë³´ë‚¼ ë•Œ ë¡œë”©ë°” ìˆ¨ê¹€ í•¨ìˆ˜
 */
function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
}
```

### ğŸ“Œ 0-3. ì „ì²´ ìƒí’ˆ ê²€ìƒ‰ í˜ì´ì§€ë„¤ì´ì…˜ êµ¬í˜„
- í˜ì´ì§€ë„¤ì´ì…˜ ê´€ë ¨ ì •ë³´ë¥¼ ë‹´ëŠ” DTOë¡œ í•´ë‹¹ DTO ë‚´ë¶€ì—ì„œ ê³„ì‚° ë¡œì§ê¹Œì§€ ìˆ˜í–‰í•œë‹¤.
- í˜„ì¬ í˜ì´ì§€ëŠ” dbì—ì„œ select í•´ì˜¬ë•Œ limitì˜ ë²”ìœ„ë¥¼ ìœ„í•´ ê¼­ í•„ìš”í•˜ë©° ê²€ìƒ‰ í˜ì´ì§€ ìš”ì²­ì‹œì— íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ëœë‹¤. 
- ì²˜ìŒí˜ì´ì§€ì— ì ‘ê·¼í•œë‹¤ë©´ defult ê°’ì€ 1ì´ë‹¤.
- ì´ dtoë¥¼ ì‚¬ìš©í•˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì •ì˜í•œ í•œ í˜ì´ì§€ì— ë³´ì—¬ì¤„ ìƒí’ˆ ê°œìˆ˜, í•œ ê·¸ë£¹ì— í‘œì‹œí•  í˜ì´ì§€ ë²ˆí˜¸ ê°œìˆ˜ ì— ë”°ë¼ì„œ ê³„ì‚° ê°’ì´ ë°”ë€ŒëŠ” êµ¬ì¡°ì´ë‹¤.
- ê·¸ë£¹ í˜ì´ì§€ì™€ ì‹œì‘í˜ì´ì§€ ë“±ì€ í˜ì´ì§€ë¥¼ ë„˜ê¸°ëŠ” ì‘ì—…ì„ í• ë•Œ ì‚¬ìš©í•œë‹¤.
```java
@Data
public class PageDTO {
    // ìƒì„±ìì— ì„ ì…ë ¥
    private int nowPage; // í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸
    private int totalProductCount; // ì „ì²´ ìƒí’ˆ ê°œìˆ˜    
    private int productsPerPage; // í•œ í˜ì´ì§€ì— ë³´ì—¬ì¤„ ìƒí’ˆ ê°œìˆ˜
    private int pagesPerGroup; // í•œ ê·¸ë£¹ì— í‘œì‹œí•  í˜ì´ì§€ ë²ˆí˜¸ ê°œìˆ˜

    // ì„ ì…ë ¥ëœ ì •ë³´ë¡œ ìƒˆë¡œìš´ ì •ë³´ ìƒì‚°
    private int totalPage; // ì „ì²´ í˜ì´ì§€ ìˆ˜
    private int startPage; // í˜„ì¬ ê·¸ë£¹ì˜ ì‹œì‘ í˜ì´ì§€
    private int endPage; // í˜„ì¬ ê·¸ë£¹ì˜ ë§ˆì§€ë§‰ í˜ì´ì§€
    private int prevPage; // ì´ì „ ê·¸ë£¹ì˜ ë§ˆì§€ë§‰ í˜ì´ì§€
    private int nextPage; // ë‹¤ìŒ ê·¸ë£¹ì˜ ì²« í˜ì´ì§€
    private int dbOffset; // DB ì¿¼ë¦¬ LIMIT OFFSET ê°’ (ê±´ë„ˆë›¸ ë ˆì½”ë“œ ìˆ˜)

    public PageDTO(int nowPage, int totalProductCount, int productsPerPage, int pagesPerGroup){
        this.nowPage = nowPage;
        this.totalProductCount = totalProductCount;
        this.productsPerPage = productsPerPage;
        this.pagesPerGroup = pagesPerGroup;

        totalPage = ((totalProductCount - 1) / productsPerPage) + 1; // í•œ ì „ì²´ìƒí’ˆ ê°œìˆ˜ë¥¼ í•œí˜ì´ì§€ì— ë³´ì—¬ì¤„ ìƒí’ˆ ê°œìˆ˜ë¡œ ë‚˜ëˆ” -> ì „ì²´ í˜ì´ì§€ ìˆ˜ ê³„ì‚°

        if (nowPage < 0){ // 1í˜ì´ì§€ë¶€í„° ì‹œì‘
            nowPage = 1;
        }

        else if (nowPage > totalPage){ // í˜ì´ì§€ë²ˆí˜¸ ë§ˆì§€ë§‰ì€ ì „ì²´ í˜ì´ì§€ ìˆ˜ë³´ë‹¤ í¬ë©´ ì•ˆë¨
            nowPage = totalPage;
        }
        
        startPage = ((nowPage - 1) / pagesPerGroup) * pagesPerGroup + 1; // ë„˜ì–´ê°„ í˜ì´ì§€ìˆ˜ë¥¼ 0ìœ¼ë¡œ ë§Œë“¤ê¸° -> ì›ë˜ 5ì´ ìµœëŒ€ë©´ 5ì— ë„˜ì–´ê°€ëŠ”ë° ê·¸ ë²”ìœ„ë¥¼ 5ê¹Œì§€ë„ ì•ˆë„˜ì–´ê°€ê²Œ ì „ì²´ë¥¼ ë’¤ë¡œ 1 ì´ë™
        endPage = startPage - 1 + pagesPerGroup;

        if (endPage > totalPage){
            endPage = totalPage;
        }

        // ì´ì „ í˜ì´ì§€, ì´í›„ í˜ì´ì§€ëŠ” ì´ì „, ì´í›„ê°€ ì—†ìœ¼ë©´ ëª¨ë‘ ê°’ì„ 0ìœ¼ë¡œ ë§Œë“¦
        prevPage = (startPage > pagesPerGroup) ? startPage - 1 : 0;
        nextPage = (endPage < totalPage) ? endPage + 1 : 0;

        dbOffset = (nowPage - 1) * productsPerPage; // limit ê°’ ì„¤ì •í•  ë•Œ ì‹œì‘ê°’ì€ 0ì—ì„œ ì‹œì‘
    }
}
```
- ê° ìƒí’ˆ ì¡°íšŒ ë°©ë²• ë³„ë¡œ ì¹´ìš´íŠ¸ í•¨ìˆ˜ì™€ ì‹¤ì œ ì¡°íšŒí•¨ìˆ˜ë¥¼ êµ¬í˜„í•˜ì—¬ ì¹´ìš´íŠ¸í•œ ì •ë³´ë¥¼ í† ëŒ€ë¡œ í˜ì´ì§€ ê°ì²´ë¥¼ ë§Œë“¤ê³  ì´ë¥¼ í†µí•´ mapperë¡œ ì •ë³´ë¥¼ ë³´ë‚¸ë‹¤.
```java
@GetMapping("/main-search")
public String search(@RequestParam(value = "keyword", defaultValue = "") String keyword,
                    @RequestParam(name="sort", defaultValue="accuracy") String sortRaw,
                    @RequestParam(value = "page", defaultValue = "1") int nowPage,
                    Model model) throws Exception {

    // í˜ì´ì§€ ë„¤ì´ì…˜ ì¤€ë¹„
    int totalProductCount = 0; // ì¡°íšŒëœ ì „ì²´ ìƒí’ˆ ê°œìˆ˜
    int productsPerPage = 10; // í•œ í˜ì´ì§€ì— ë³´ì—¬ì¤„ ìƒí’ˆ ìˆ˜
    int pagesPerGroup = 5; // í•œ ê·¸ë£¹ì— í‘œì‹œí•  í˜ì´ì§€ ë²ˆí˜¸ ê°œìˆ˜

    SearchSort sort = SearchSort.from(sortRaw); // ê²€ìƒ‰ì–´ ì •ë¦¬
    String inputKeyword = keyword.trim();
    
    List<Product> list;
    PageDTO pageDTO;
    
    if (inputKeyword.isEmpty()) {
        // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ì „ì²´ ìƒí’ˆ ê°œìˆ˜ ì¡°íšŒ
        totalProductCount = mainSearchService.countAllProducts();
        
        // í˜ì´ì§€ ì •ë³´ ìƒì„±
        pageDTO = new PageDTO(nowPage, totalProductCount, productsPerPage, pagesPerGroup);

        // í˜ì´ì§€ë„¤ì´ì…˜ ì ìš©í•˜ì—¬ ìƒí’ˆ ì¡°íšŒ
        list = mainSearchService.getAllProductsWithPagination(sort, pageDTO);

    } else {
        // ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ê²€ìƒ‰ ê²°ê³¼ ê°œìˆ˜ ì¡°íšŒ
        totalProductCount = mainSearchService.countTokenizedSearch(inputKeyword);
        
        // í˜ì´ì§€ ì •ë³´ ìƒì„±
        pageDTO = new PageDTO(nowPage, totalProductCount, productsPerPage, pagesPerGroup);
            // í˜ì´ì§€ë„¤ì´ì…˜ ì ìš©í•˜ì—¬ ê²€ìƒ‰ ì‹¤í–‰
        list = mainSearchService.tokenizedSearchWithPagination(inputKeyword, sort, pageDTO);
    }

    model.addAttribute("keyword", inputKeyword);
    model.addAttribute("sort", sort.getValue());
    model.addAttribute("products", list);
    model.addAttribute("resultCount", totalProductCount);
    model.addAttribute("pageDTO", pageDTO);

    return "main_search/index";
}
```
- ë§¤í¼ì—ì„œ ì¹´ìš´íŠ¸ í•¨ìˆ˜ëŠ” í•´ë‹¹ ì¡°ê±´(ì „ì²´ í˜¹ì€ í† í¬ë‚˜ì´ì¦ˆëœ ë‹¨ì–´ê°€ í¬í•¨ëœ ê²°ê³¼ë¬¼)ì˜ ê°œìˆ˜ë¥¼ ì¹´ìš´íŠ¸í•œë‹¤.
- ì¼ë°˜ ì¡°íšŒ mapperëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì •ë ¬ ì•Œê³ ë¦¬ì¦˜ì„ í†µí•´ ì •ë ¬í•˜ë˜ limitë¥¼ ê±°ëŠ”ë° limit - offset êµ¬ë¬¸ì„ ì‚¬ìš©í•œë‹¤.
- LIMIT nì´ë©´ ìµœ nê°œì˜ ë°ì´í„°ë¥¼ ë°˜í™˜í•œë‹¤ëŠ” ì˜ë¯¸ì´ê³ , OFFSET m ì€ ëª‡ ë²ˆì§¸ í–‰ë¶€í„° ì‹œì‘í•´ì„œ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¬ì§€ ì§€ì •í•œë‹¤. ì˜ˆë¥¼ ë“¤ì–´, OFFSET 20ì´ë©´, 21ë²ˆì§¸ í–‰ë¶€í„° ê²°ê³¼ë¥¼ ë°˜í™˜í•œë‹¤.
- ì´ offsetì„ dto ë‚´ë¶€ì—ì„œ dbOffset = (nowPage - 1) * productsPerPage; ì´ë ‡ê²Œ ê³„ì‚°í•˜ë¯€ë¡œ í˜„ì¬ í˜ì´ì§€ ì „ê¹Œì§€ ì¶œë ¥ëœ ìƒí’ˆê°œìˆ˜ë¥¼ ì˜ë¯¸í•œë‹¤.
- mapperì—ì„œ pageDTO ë‚´ë¶€ì˜ ì •ë³´ë¥¼ ë½‘ì•„ì“´ë‹¤.
```java
@Select("""
    SELECT c.color_name, c.color_code, pc.product_img
    FROM product_color pc
    JOIN colors c ON pc.color_id = c.color_id
    WHERE pc.product_id = #{productId}
""")
@Results({
    @Result(column = "color_name", property = "colorName"),
    @Result(column = "color_code", property = "colorCode"),
    @Result(column = "product_img", property = "productImg")
})    
List<Color> getColorOptionsByProductId(@Param("productId") int productId);    

@ResultMap("productMap")
@Select("""
    <script>
    SELECT
        p.*,
        (<foreach collection='tokens' item='tk' separator=' + '>
            (LOCATE(#{tk}, p.product_name) > 0) * 10
            + (LOCATE(#{tk}, ca.category_name) > 0) * 4
            + (LOCATE(#{tk}, sc.sub_category_name) > 0) * 3
        </foreach>) AS relevance
    FROM products p
    LEFT JOIN sub_categories sc ON p.sub_category_id = sc.sub_category_id
    LEFT JOIN categories ca ON sc.category_id = ca.category_id
    <where>
        <foreach collection='patterns' item='ptn' separator=' AND '>
            ((p.product_name LIKE #{ptn} ESCAPE '!')
            OR (ca.category_name LIKE #{ptn} ESCAPE '!')
            OR (sc.sub_category_name LIKE #{ptn} ESCAPE '!'))
        </foreach>
    </where>

    <choose>
        <when test="sort.name() == 'ACCURACY'">
            ORDER BY relevance DESC, p.reg_date DESC
        </when>
        <otherwise> 
            ORDER BY p.reg_date DESC
        </otherwise>
    </choose>
    LIMIT #{pageDTO.productsPerPage} OFFSET #{pageDTO.dbOffset}
    </script>
    """)
List<Product> searchProductsWithPagination(@Param("tokens") String[] tokens, 
                                            @Param("patterns") List<String> patterns, 
                                            @Param("sort") SearchSort sort,
                                            @Param("pageDTO") PageDTO pageDTO);

@Select("""
    <script>
    SELECT COUNT(*)
    FROM products p
    LEFT JOIN sub_categories sc ON p.sub_category_id = sc.sub_category_id
    LEFT JOIN categories ca ON sc.category_id = ca.category_id
    <where>
        <foreach collection='patterns' item='ptn' separator=' AND '>
            ((p.product_name LIKE #{ptn} ESCAPE '!')
            OR (ca.category_name LIKE #{ptn} ESCAPE '!')
            OR (sc.sub_category_name LIKE #{ptn} ESCAPE '!'))
        </foreach>
    </where>
    </script>
    """)    
int countSearchProducts(@Param("tokens") String[] tokens, @Param("patterns") List<String> patterns);    


@ResultMap("productMap")
@Select("""
    <script>
    SELECT * FROM products
    <choose>
        <when test="sort.name() == 'LATEST'">
            ORDER BY reg_date DESC
        </when>
        <otherwise>
            ORDER BY product_name ASC
        </otherwise>
    </choose>
    LIMIT #{pageDTO.productsPerPage} OFFSET #{pageDTO.dbOffset}
    </script>
    """)
List<Product> getAllProductsWithPagination(@Param("sort") SearchSort sort,
                                            @Param("pageDTO") PageDTO pageDTO);


@Select("SELECT COUNT(*) FROM products")
int countAllProducts();
```
- ì´ì „ ë²„íŠ¼ì€ ì´ì „ ê·¸ë£¹ì˜ ë§ˆì§€ë§‰ í˜ì´ì§€ë¡œ ì´ë™í•˜ë„ë¡í•˜ê³  ë‹¤ìŒì€ ë‹¤ìŒ ê·¸ë£¹ì˜ ì²«ë²ˆì§¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ê²Œ í•œë‹¤.
- í´ë¦­í–ˆì„ë•Œ ì •ë ¬ê¸°ì¤€ì„ ìœ ì§€í•˜ë©´ì„œ ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™í•˜ë„ë¡ í•œë‹¤.
```html
<!-- í˜ì´ì§€ ë²ˆí˜¸ -->
<ul class="pagination">
    <!-- ì´ì „ í˜ì´ì§€ ê·¸ë£¹ ì´ë™ ë²„íŠ¼ -->
    <li th:if="${pageDTO.prevPage > 0}"> 
        <a th:href="@{/main-search(keyword=${keyword}, sort=${sort}, page=${pageDTO.prevPage})}">ì´ì „</a>
    </li>
    <li th:unless="${pageDTO.prevPage > 0}">
        <a class="disabled">ì´ì „</a>
    </li>

    <!-- í˜ì´ì§€ ë²ˆí˜¸ ë§í¬ -->
    <li th:each="i : ${#numbers.sequence(pageDTO.startPage, pageDTO.endPage)}">
        <a th:if="${i == pageDTO.nowPage}" class="active" th:text="${i}"></a>
        <a th:unless="${i == pageDTO.nowPage}" th:text="${i}"
            th:href="@{/main-search(keyword=${keyword}, sort=${sort}, page=${i})}"></a>
    </li>

    <!-- ë‹¤ìŒ í˜ì´ì§€ ê·¸ë£¹ ì´ë™ ë²„íŠ¼ -->
    <li th:if="${pageDTO.nextPage > 0}">
        <a th:href="@{/main-search(keyword=${keyword}, sort=${sort}, page=${pageDTO.nextPage})}">ë‹¤ìŒ</a>
    </li>
    <li th:unless="${pageDTO.nextPage > 0}">
        <a class="disabled">ë‹¤ìŒ</a>
    </li>
</ul>
```