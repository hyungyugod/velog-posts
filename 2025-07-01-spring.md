# ğŸ“Œ 0. ë³´ìŠ¤ í´ë¡  í”„ë¡œì íŠ¸
### ğŸ“Œ 0-1. ê¸°ì¡´ì˜ join-group by ë¬¸ì œ í•´ê²° -> CTE í™œìš© ê³„ì‚°ëŸ‰ ë§ì€ ê°’ë¶€í„° ê³„ì‚°
- ê¸°ì¡´ì— joinìœ¼ë¡œ products í…Œì´ë¸”ì„ ì—®ì€ ë‹¤ìŒì— group byë¡œ í•œ íšŒì›ì˜ ìƒí’ˆ ë³„ë¡œ í•˜ë‚˜ì”© ë¬¶ì¼ ìˆ˜ ìˆë„ë¡ ì¿¼ë¦¬ë¥¼ ì§°ì—ˆëŠ”ë° ì§‘ê³„í•¨ìˆ˜ë¥¼ ì¨ì„œ ë§ì€ ìƒí’ˆë“¤ì„ í•˜ë‚˜ë¡œ ë¬¶ì—ˆì–´ì•¼ í•´ì„œ ì¡°ì¸ëœ ê±°ì— ë„ˆë¬´ ë§ì€ ì—°ì‚°ì´ ë“¤ì–´ê°”ì—ˆë‹¤.
- ê·¸ë˜ì„œ ìš°ì„  ìƒí’ˆì˜ ì¤‘ë³µì„ ì œê±°í•´ë‘ê³  ê±°ê¸°ì— ì¡°ì¸ì„ ë¶™ì—¬ì„œ í•œ í–‰ì”© ì¶œë ¥í•˜ì—¬ ë¶ˆí•„ìš”í•œ ê³„ì‚°ì„ ì¤„ì˜€ë‹¤.
- cteë¥¼ ë‘ê°œ ìƒì„±í•˜ê³  í•©ì³ì„œ ê³„ì‚°ì„ ì§„í–‰í•˜ì˜€ë‹¤.
- JOIN + GROUP BY: â€œì „ì²´ í•™ìƒë“¤ì˜ í‰ê·  ì„±ì , ì´ì , ì¸ì›ìˆ˜ ë“±ë§Œ ì•Œë ¤ì£¼ê³  í•™ìƒ ê°œë³„ ì‹œí—˜ì§€ ë‚´ìš©ì€ ë”°ë¡œ ë³´ë ¤ë©´ ë˜ ì°¾ì•„ì•¼ í•œë‹¤â€
- ìœˆë„ìš° í•¨ìˆ˜: â€œí•™ìƒ ê°œë³„ ì‹œí—˜ì§€ ì •ë³´ì™€ ê·¸ í•™ìƒì´ ë°˜ì—ì„œ ëª‡ ë“±ì¸ì§€, ì§€ê¸ˆê¹Œì§€ ëˆ„ì  ì ìˆ˜ê¹Œì§€ í•œ ë²ˆì— ê°™ì´ ë³¼ ìˆ˜ ìˆë‹¤!â€
- ë¬¼ë¡  ìœˆë„ìš° í•¨ìˆ˜ê°€ ì •ë ¬ê³¼ íŒŒí‹°ì…˜ë³„ë¡œ ë°°ì¹˜í•˜ëŠ”ë° ì‹œê°„ì´ ì¢€ ê±¸ë¦¬ì§€ë§Œ ë°°ì¹˜ë§Œ í•´ë‘ë©´ í•œë²ˆì— ìƒì„¸ì •ë³´ì™€ ê·¸ ì˜†ì— ì›í•˜ëŠ” ì§‘ê³„ì •ë³´ë¥¼ ê°™ì´ ë³¼ ìˆ˜ ìˆê³  ì´ëŠ” ì›ë˜ ë§¤ í–‰ë§ˆë‹¤ ìƒˆë¡œ ì „ì²´ ê³„ì‚°ì„ í–ˆì–´ì•¼í•˜ëŠ” ë°©ì‹ë³´ë‹¤ í›¨ì”¬ ë‚«ë‹¤.
- ì¦‰ í•œë²ˆ ì •ë ¬í•´ë‘ë©´ ì§‘ê³„ì •ë³´ë¥¼ ì¸ë±ìŠ¤ë§Œ ë³´ë©´ì„œ ë°”ë¡œ ì •ë¦¬í•  ìˆ˜ ìˆìŒ.
- ìœˆë„ìš° í•¨ìˆ˜ëŠ” ì—¬ëŸ¬í–‰ì„ í•œë²ˆì— ë©”ëª¨ë¦¬ì— ì˜¬ë ¤ë‘ê³  cpuê°€ ë³‘ë ¬ì²˜ë¦¬í•˜ì—¬ ê³„ì‚°í•œë‹¤.
- ë²¡í„°í™”: ì ì´ ì„ (í™”ì‚´í‘œ)ì´ ë˜ëŠ”ê±´ì²˜ëŸ¼ í–‰ì´ ëª¨ì—¬ ë°°ì—´ì„ ì´ë£¬ë‹¤ëŠ” ì˜ë¯¸ì—ì„œ ë²¡í„°í™”ê°€ ë¬¶ìŒì²˜ë¦¬ë¥¼ ì˜ë¯¸í•œë‹¤.
```java
@Results(id="CartMap", value={
        /* ëŒ€í‘œí‚¤ Â· ê¸°ë³¸í•„ë“œ */
        @Result(column="cart_id", property="cartId"),      // MIN(cart_id)
        @Result(column="user_id", property="userId"),
        @Result(column="product_id", property="productId"),
        @Result(column="delivery_method", property="deliveryMethod"),
        @Result(column="delivery_price", property="deliveryPrice"),
        @Result(column="reg_date", property="regDate"),
        @Result(column="edit_date", property="editDate"),

        /* ìƒí’ˆ ì •ë³´ */
        @Result(column="product_name", property="productName"),
        @Result(column="product_price", property="productPrice"),
        @Result(column="product_img", property="productImg"),

        /* ì˜µì…˜ ì»¬ë ‰ì…˜ */
        @Result(property="options",
                column="{uid=user_id,pid=product_id}",
                many=@Many(select="selectOptionsByUserAndProduct")),

        /* íŒ”ë ˆíŠ¸ */
        @Result(property="allColors",
                column="product_id",
                many=@Many(select="selectAllColorsByProduct")),

        /* ì´ ìˆ˜ëŸ‰ */
        @Result(column="totalQty", property="totalQty")
        })
    @Select("""
        WITH latestProduct AS (
            SELECT *
                FROM (
                        SELECT c.*,
                            ROW_NUMBER() OVER (PARTITION BY c.product_id
                                                ORDER BY c.edit_date DESC) AS rn
                        FROM carts c
                        WHERE c.user_id = #{userId}
                    ) t
                WHERE t.rn = 1
        ),
        qty AS (
            SELECT product_id, SUM(product_quantity) AS totalQty
                FROM carts
                WHERE user_id = #{userId}
                GROUP BY product_id
        )
        SELECT  l.cart_id, l.user_id, l.product_id,
                l.delivery_method, l.delivery_price,
                l.reg_date, l.edit_date,
                p.product_name, p.product_price, p.product_img,
                q.totalQty
        FROM latestProduct  l
        JOIN qty q ON q.product_id = l.product_id
        JOIN products p ON p.product_id = l.product_id
        ORDER BY l.edit_date DESC
        """)
    List<Cart> selectCartListByUserId(Cart param) throws Exception;   // param ì— userId ë§Œ ì„¸íŒ…í•´ì„œ í˜¸ì¶œ
```

### ğŸ“Œ 0-2. main_search page html ë°˜ë³µ 
- ë°˜ë³µë¬¸ th:each="p : ${products}"ì€ ì›ë˜ ë°˜ë³µí•˜ê³  ì‹¶ì€ ìµœì†Œë‹¨ìœ„ íƒœê·¸ì— ë¶™ì´ëŠ” ê²ƒì´ ì •ì„ì´ë‹¤.
```html
<!-- ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ ë°˜ë³µ -->
    <ul class="search-result-list">
        <li class="search-result-item"
            th:each="p : ${products}">
            <!-- ìƒí’ˆ ìƒì„¸ë¡œ ì´ë™ -->
            <a th:href="@{|/product/${p.productId}|}"> <!-- ìƒí’ˆ í˜ì´ì§€ ì •ë³´ ë‚˜ì˜¤ë©´ ìˆ˜ì •í•„ìš” -->
                <img th:src="${p.productImg}" alt="ìƒí’ˆ ì´ë¯¸ì§€" class="search-thumb"/>
            </a>
            <div class="search-item-info">
                <div class="search-item-title">
                    <a th:href="@{|/product/${p.productId}|}"> <!-- ìƒí’ˆ í˜ì´ì§€ ì •ë³´ ë‚˜ì˜¤ë©´ ìˆ˜ì •í•„ìš” -->
                        <b th:text="${p.productName}">[BOSE] í—¤ë“œí°</b>
                    </a>
                </div>
                <!-- ê³ ì • ë¬¸êµ¬ -->
                <div class="search-item-desc">
                    ë³´ìŠ¤ ì½”ë¦¬ì•„ ì •í’ˆ 1ë…„ A/S ë³´ì¥. ê³µì‹ëª° íšŒì› ì „ìš© ì¿ í° ì¦ì •.
                </div>
                <div class="search-item-price-row">
                    <span class="search-item-sale"
                        th:text="${#numbers.formatInteger(p.productPrice, 0, 'COMMA')} + 'ì›'">
                        329,000ì›
                    </span>
                </div>
            </div>
        </li>
    </ul>
```

### ğŸ“Œ 0-3. MainSearchService
- String[] tokens = keyword.trim().split("\\s+"); : \sëŠ” space ì¦‰ ê³µë°±ì„ ì˜ë¯¸í•œë‹¤. +ëŠ” í•˜ë‚˜ ì´ìƒì´ë¼ëŠ” ì˜ë¯¸ì´ë‹¤. ì´ë•Œ ì—­ìŠ¬ë˜ì‹œë¥¼ ìë°”ì—ì„œ ì˜¨ì „íˆ ì“°ë ¤ë©´ ì—­ìŠ¬ë˜ìŠ¤ë¥¼ ì´ìŠ¤ì¼€ì´í”„ ë¬¸ìë¡œ ì¸ì‹í•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ í•œë²ˆ ë” ì¨ì£¼ì–´ì•¼ í•œë‹¤. ì¦‰ ì‹¤ì œ ì •ê·œí‘œí˜„ì‹ì€ \s+ì´ê³  Java ë¬¸ìì—´ë¡œëŠ” "\\s+"ì¸ ê²ƒì´ë‹¤.
- sql êµ¬ë¬¸ì—ì„œ WHERE name LIKE '%!_%' ESCAPE '!'; ì´ë ‡ê²Œ ì“°ë©´ ì´ëŠ” !ë¥¼ ì´ìŠ¤ì¼€ì´í”„ ë¬¸ì ì¦‰ ë’¤ì— ë¶™ì€ ë¬¸ìë¥¼ ì›ë˜ì˜ ì—­í• ì—ì„œ íƒˆì¶œì‹œí‚¤ê¸° ìœ„í•´ ë¶™ì€ ë¬¸ìë¼ëŠ” ê²ƒì„ ì˜ë¯¸í•œë‹¤.
- ê²°êµ­ ëª¨ë“  ì„¸ë¶„í™”ëœ í† í°ë“¤ì— %%ë¥¼ ë¶™ì—¬ì„œ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.
- ì´ëŸ° ì²˜ë¦¬ëŠ” â€œí‚¤ì›Œë“œ ì „ì²˜ë¦¬â€ë¥¼ ë¹„ì¦ˆë‹ˆìŠ¤ ê³„ì¸µì— ë‘ê³ , SQLì€ ìˆœìˆ˜ ì¡°íšŒë§Œ ë‹´ë‹¹í•˜ë„ë¡ í•˜ê¸° ìœ„í•¨ì´ê³  
```java
@Override
    public List<Product> TokenizedSearch(String keyword, SearchSort sort) {

        // ê²€ìƒ‰ í‚¤ì›Œë“œê°€ ì—†ìœ¼ë©´ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜
        if(keyword == null || keyword.trim().isEmpty())
            return List.of();  // ë¹ˆ ê²°ê³¼ ë°˜í™˜

        // í† í¬ë‚˜ì´ì¦ˆ(ê³µë°± ê¸°ì¤€ìœ¼ë¡œ)
        String[] tokens = keyword.trim().split("\\s+");

        // ê° í† í°ì„ LIKE íŒ¨í„´ìœ¼ë¡œ ë³€í™˜  (%í† í°%)
        List<String> patterns = Arrays.stream(tokens)
            .map(this::escapeLike)     // ì´ìŠ¤ì¼€ì´í”„ ë¬¸ìë¥¼ ë¶™ì„
            .map(t -> "%" + t + "%")   // ì–‘ìª½ % ì¶”ê°€ -> like ê²€ìƒ‰ì„ ìœ„í•œ íŒ¨í„´
            .toList(); 

        // Mapper í˜¸ì¶œ â€“ í† í°, íŒ¨í„´, ì •ë ¬ ì „ë‹¬
        return mapper.searchProducts(tokens, patterns, sort);
    }

    /** %, _, !ë¥¼ ì´ìŠ¤ì¼€ì´í”„ì‹œí‚¤ê¸° ìœ„í•œ ë©”ì„œë“œ */
    private String escapeLike(String src){
        return src.replace("!", "!!")
                    .replace("%","!%")
                    .replace("_","!_");
    }
```

### ğŸ“Œ 0-4. mainsearch mapper - í† í¬ë‚˜ì´ì¦ˆ ê°€ì¤‘ì¹˜ ë¶€ì—¬ ì²˜ë¦¬
- ì´ëŠ” ë‹¨ì–´ ë‹¨ìœ„ë¡œ ìª¼ê°œì§„ ê²€ìƒ‰ì–´ê°€ ìƒí’ˆì´ë¦„, ì¹´í…Œê³ ë¦¬ì´ë¦„, í•˜ìœ„ì¹´í…Œê³ ë¦¬ ì´ë¦„ì— í¬í•¨ëœ ìœ„ì¹˜ì— ë”°ë¼ ê°€ì¤‘ì¹˜ë¥¼ ë¶€ì—¬í•˜ì—¬ ì •í™•ë„ë¥¼ ê³„ì‚°í•˜ëŠ” ì—­í• ê³¼ ì •ë ¬ë°©ì‹ì— ë”°ë¼ ê²€ìƒ‰ëœ ìƒí’ˆì„ ì •ë ¬í•˜ì—¬ ë°˜í™˜í•˜ëŠ” ë§¤í¼ì´ë‹¤.
- collection='tokens' : ë°˜ë³µí•  ì»¬ë ‰ì…˜ ë³€ìˆ˜ ì´ë¦„ì„ ì˜ë¯¸í•œë‹¤. ì—¬ê¸°ì„  ë¦¬ìŠ¤íŠ¸ ì»¬ë ‰ì…˜ì´ë‹¤.
- item='tk' : ì»¬ë ‰ì…˜ì˜ ë³€ìˆ˜ë¥¼ ë°˜ë³µí•  ë•Œ ê°ê°ì˜ ìš”ì†Œë¥¼ ì„ì‹œë¡œ ì €ì¥í•˜ëŠ” ë³€ìˆ˜ ì´ë¦„ì´ë‹¤. 
- separator=' + ' : ì´ë¥¼ í†µí•´ ê° ë°˜ë³µ ê²°ê³¼ ì‚¬ì´ì— +ë¡œ ë„£ì–´ ì´ì–´ë¶™ì¸ë‹¤ -> ê°€ì¤‘ì¹˜ ë¶€ì—¬
- (p.product_name LIKE #{ptn} ESCAPE '!'): like ì—°ì‚°ì„ ìˆ˜í–‰í•˜ë©´ì„œ ë¶™ì—¬ë†¨ë˜ !ê°€ ì´ìŠ¤ì¼€ì´í”„ ë¬¸ìë‹ˆê¹Œ ë¬´ì‹œí•˜ë¼ëŠ” ì˜ë¯¸ì´ë‹¤.
- test="sort == @com.clonebose.bose.models.SearchSort@ACCURACY" enum íƒ€ì…ì˜ ìœ„ì¹˜ì˜ ê°’ê³¼ ì‹¤ì œ enum íƒ€ì…ì´ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì‚¬í•˜ëŠ” ì½”ë“œì´ë‹¤.
- ë˜ ê²°ê³¼ëŠ” ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬í•´ì•¼ ìµœì‹ ìˆœ, ì •í™•ë„ê°€ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬í•  ìˆ˜ ìˆë‹¤.
```java
@Select("""
        <script>
        SELECT
            p.*,
            (<foreach collection='tokens' item='tk' separator=' + '>
                (LOCATE(#{tk}, p.product_name) > 0) * 10
                + (LOCATE(#{tk}, ca.category_name) > 0) * 4
                + (LOCATE(#{tk}, sc.sub_category_name) > 0) * 3
            </foreach>) AS relevance
        FROM products p
        LEFT JOIN sub_categories sc ON p.sub_category_id = sc.sub_category_id
        LEFT JOIN categories ca ON sc.category_id = ca.category_id
        <where>
            <foreach collection='patterns' item='ptn' separator=' AND '>
                ((p.product_name LIKE #{ptn} ESCAPE '!')
                OR (ca.category_name LIKE #{ptn} ESCAPE '!')
                OR (sc.sub_category_name LIKE #{ptn} ESCAPE '!'))
            </foreach>
        </where>

        <choose>
            <when test="sort == @com.clonebose.bose.models.SearchSort@ACCURACY">
                ORDER BY relevance DESC, p.reg_date DESC
            </when>
            <otherwise> 
                ORDER BY p.reg_date DESC
            </otherwise>
        </choose>
        </script>
        """)
    List<Product> searchProducts(@Param("tokens") String[] tokens, @Param("patterns") List<String> patterns, @Param("sort") SearchSort sort);
```

### ğŸ“Œ 0-5. mainsearch mapper í…ŒìŠ¤íŠ¸ì½”ë“œ
- @AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE) : spring bootì˜ í…ŒìŠ¤íŠ¸ ë°ì´í„° ë² ì´ìŠ¤ ëŒ€ì‹  ì‹¤ì œ ë°ì´í„° ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë„ë¡ í•œë‹¤.
- given: í…ŒìŠ¤íŠ¸ì˜ ì¤€ë¹„ ë‹¨ê³„ â†’ â€œì´ëŸ° ì¡°ê±´/ìƒíƒœ/ì…ë ¥ê°’ì´ ì¤€ë¹„ë˜ì–´ ìˆë‹¤â€
- when: í–‰ë™(ì•¡ì…˜) ìˆ˜í–‰ ë‹¨ê³„ â†’ â€œì´ë ‡ê²Œ ë™ì‘/ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤â€
- then: ê²°ê³¼ ê²€ì¦ ë‹¨ê³„ â†’ â€œê²°ê³¼ê°€ ì´ë ‡ê²Œ ë‚˜ì™€ì•¼ í•œë‹¤(ê²€ì¦/Assertion)â€
- assertNotNull(nullì¸ì§€ ê²€ì‚¬ ì•„ë‹ˆë©´ ë§¤ì„¸ì§€ ì¶œë ¥), assertTrue, assertFalseì€ ê°ê° ì°¸ì¸ì§€ ê±°ì§“ì¸ì§€ë¥¼ ê²€ì‚¬í•œë‹¤.
- List.of("%í—¤ë“œí°%"); ì´ë ‡ê²Œ í•˜ë©´ ì›ì†Œê°€ ë‹¨ í•˜ë‚˜(â€œ%í—¤ë“œí°%â€)ë§Œ ë“¤ì–´ìˆëŠ” ë¶ˆë³€(immutable) ë¦¬ìŠ¤íŠ¸ê°€ ë§Œë“¤ì–´ì§„ë‹¤.
- result.get(0).getRegDate().compareTo(result.get(1).getRegDate()) >= 0, : a-b ì—°ì‚° ì• ì›ì†Œê°€ ë” í¬ë©´ ìµœì‹  ê°’ì´ë¯€ë¡œ ì´ ê°’ì´ 0ë³´ë‹¤ ì»¤ì•¼ ì°¸ì´ë‹¤.
- ì •í™•ë„ ê²€ì‚¬ëŠ” ê²°ê³¼ë¥¼ ë°˜ë³µëŒë©´ì„œ í† í°ì„ í¬í•¨í•˜ë©´ ì ìˆ˜ë¥¼ ì˜¬ë¦¬ëŠ” ì‹ìœ¼ë¡œ í•˜ê³  ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ì—ì„œ ë‘ë²ˆì§¸ ì›ì†Œê°€ ë§Œì•½ ì²«ë²ˆì§¸ ì›ì†Œë³´ë‹¤ ì ìˆ˜ê°€ ë†’ìœ¼ë©´ ì˜ëª»ëœ ê²ƒì´ë‹¤.
- ì¼ë‹¨ ê²°ê³¼ë¥¼ ì‚°ì¶œí•˜ëŠ” ë©”ì„œë“œì´ë©´ ìˆëŠ” ë³€ìˆ˜ë¥¼ ë½‘ì€ ë‹¤ìŒì— ê²°ê³¼ê°€ ì˜ ë‚˜ì˜¤ëŠ”ì§€ ê²€ì‚¬í•´ì•¼í•˜ê³  ë³¸ë˜ê¸°ëŠ¥ì„ ì˜ í•˜ê³  ìˆëŠ”ì§€ ê²€ì‚¬í•œë‹¤.
- ìµœì‹ ìˆœ ì •ë ¬ì€ ìƒí’ˆì„ ë½‘ì•˜ì„ë•Œ ìƒí’ˆë“¤ì˜ ë“±ë¡ë‚ ì§œë¥¼ 2ê°œë§Œ ë¹„êµí•˜ì—¬ ì•ì—ê²Œ ë” í°ì§€ë§Œ ë³´ë©´ ëœë‹¤.
```java
@Slf4j
@SpringBootTest
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)  // ìš´ì˜ DB ê·¸ëŒ€ë¡œ ì‚¬ìš©!
class ProductMapperTests {

    @Autowired
    private ProductMapper productMapper;

    @Test
    void testSearchProducts_withRealData() {
        // given
        // "í—¤ë“œí°"ì´ í¬í•¨ëœ ìƒí’ˆëª…, ì¹´í…Œê³ ë¦¬, ì„œë¸Œì¹´í…Œê³ ë¦¬ê°€ ì‹¤ì œë¡œ ì¡´ì¬í•´ì•¼ í•œë‹¤!
        String[] tokens = {"í—¤ë“œí°"};
        List<String> patterns = List.of("%í—¤ë“œí°%");
        SearchSort sort = SearchSort.ACCURACY;

        // when
        List<Product> result = productMapper.searchProducts(tokens, patterns, sort);

        // then
        assertNotNull(result);
        assertFalse(result.isEmpty(), "ê²€ìƒ‰ ê²°ê³¼ê°€ ìµœì†Œ 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");

        // ê°€ì¥ relevanceê°€ ë†’ì€ ìƒí’ˆëª…, ìƒí’ˆì´ë¯¸ì§€ ì¶œë ¥ (ìµœì†Œ 1ê°œë§Œ ê²€ì¦)
        Product top = result.get(0);
        log.info("ìƒí’ˆID: {}, ìƒí’ˆëª…: {}, ì´ë¯¸ì§€: {}", top.getProductId(), top.getProductName(), top.getProductImg());
        assertTrue(top.getProductName().contains("í—¤ë“œí°")); // ìƒí’ˆëª…ì— 'í—¤ë“œí°'ì´ í¬í•¨ë¼ì•¼ í•œë‹¤(ê°•ì œX)
        assertNotNull(top.getProductImg());
    }

    @Test
    void testSearchProductsWithNoResult() {
        // ì—†ëŠ” ë‹¨ì–´ë¡œ ê²€ìƒ‰
        String[] tokens = {"ì§„ì§œì—†ëŠ”í‚¤ì›Œë“œ"};
        List<String> patterns = List.of("%ì§„ì§œì—†ëŠ”í‚¤ì›Œë“œ%");
        SearchSort sort = SearchSort.ACCURACY;

        List<Product> result = productMapper.searchProducts(tokens, patterns, sort);

        assertNotNull(result);
        assertTrue(result.isEmpty(), "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í‚¤ì›Œë“œëŠ” 0ê±´ì´ì–´ì•¼ í•¨");
    }

    @Test
    void testSearchProducts_latestSort() {
        // ìµœì‹ ìˆœ ì •ë ¬ë„ í™•ì¸
        String[] tokens = {"í—¤ë“œí°"};
        List<String> patterns = List.of("%í—¤ë“œí°%");
        SearchSort sort = SearchSort.LATEST;

        List<Product> result = productMapper.searchProducts(tokens, patterns, sort);

        assertNotNull(result);
        assertFalse(result.isEmpty());

        // ë“±ë¡ì¼ ë‚´ë¦¼ì°¨ìˆœ(ìµœì‹ ìˆœ) ê²€ì¦(ì˜ˆì‹œ: 2ê°œë§Œ ì²´í¬)
        if (result.size() > 1) {
            assertTrue(
                result.get(0).getRegDate().compareTo(result.get(1).getRegDate()) >= 0,
                "ìµœì‹ ìˆœ ì •ë ¬ì´ ë˜ì–´ì•¼ í•¨"
            );
        }
    }

    @Test
    void testSearchProducts_accuracySort_logicalRelevance() {
        // given
        String[] tokens = {"í—¤ë“œí°"};
        List<String> patterns = List.of("%í—¤ë“œí°%");
        SearchSort sort = SearchSort.ACCURACY;

        // when
        List<Product> result = productMapper.searchProducts(tokens, patterns, sort);

        // then
        assertNotNull(result);
        assertFalse(result.isEmpty());

        // í‚¤ì›Œë“œ í† í° í¬í•¨ ê°œìˆ˜ê°€ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ë–¨ì–´ì§€ëŠ”ì§€ ê²€ì¦
        int prevScore = Integer.MAX_VALUE;
        for (Product p : result) {
            int score = 0;
            for (String tk : tokens) {
                if (p.getProductName() != null && p.getProductName().contains(tk)) score += 10;
                // í•„ìš”ì‹œ ì¹´í…Œê³ ë¦¬ëª…/ì„œë¸Œì¹´í…Œê³ ë¦¬ëª…ë„ ê°™ì´ ê²€ì‚¬ ê°€ëŠ¥
            }
            log.info("ìƒí’ˆëª…: {}, í† í°í¬í•¨ì ìˆ˜: {}", p.getProductName(), score);

            // ë¦¬ìŠ¤íŠ¸ ìƒ ì•ì— ìˆëŠ” ìƒí’ˆì˜ ì ìˆ˜ê°€ ë’¤ì˜ ìƒí’ˆ ì ìˆ˜ ì´ìƒì´ì–´ì•¼ í•œë‹¤
            assertTrue(score <= prevScore,
                String.format("ì •í™•ë„ìˆœ ì •ë ¬ ì˜¤ë¥˜: %s(%d) â†’ %s(%d)", 
                            p.getProductName(), prevScore, p.getProductName(), score));
            prevScore = score;
        }
    }

    @Test
    void testSearchProducts_accuracySort_multiTokens() {
        String[] tokens = {"ë³´ìŠ¤", "í—¤ë“œí°"};
        List<String> patterns = List.of("%ë³´ìŠ¤%", "%í—¤ë“œí°%");
        SearchSort sort = SearchSort.ACCURACY;

        List<Product> result = productMapper.searchProducts(tokens, patterns, sort);

        assertNotNull(result);
        assertFalse(result.isEmpty());

        int prevScore = Integer.MAX_VALUE;
        for (Product p : result) {
            int score = 0;
            String name = p.getProductName() == null ? "" : p.getProductName();
            for (String tk : tokens) {
                if (name.contains(tk)) score += 10;
            }
            log.info("ìƒí’ˆëª…: {}, í† í°í¬í•¨ì ìˆ˜: {}", name, score);
            assertTrue(score <= prevScore,
                String.format("ì •í™•ë„ìˆœ ì •ë ¬ ì˜¤ë¥˜: %s(%d) â†’ %s(%d)", name, prevScore, name, score));
            prevScore = score;
        }
    }
}
```

### ğŸ“Œ 0-6. mainsearch service í…ŒìŠ¤íŠ¸ ì½”ë“œ
- ë¹„ì–´ìˆì„ë•Œì˜ ê²€ì‚¬ëŠ” nullì¸ ê²½ìš°ì™€ 0ì¸ ê²½ìš°ë¥¼ ëª¨ë‘ ë§‰ì•„ì•¼í•œë‹¤. 0ì€ nullì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì´ë‹¤. ë³´í†µ ì´ ë‘ê°œë¥¼ assertNotNull, assertFalseë¡œ ê²€ì‚¬í•˜ê³ 
- assertTrueë¡œëŠ” ì‹¤ì œ ê¸°ëŠ¥ì˜ êµ¬ì²´ì  í˜„ìƒì„ ê²€ì‚¬í•œë‹¤.
```java
@Slf4j
@SpringBootTest
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
class MainSearchServiceIntegrationTest {

    @Autowired
    private MainSearchServiceImpl service;

    @Test
    void searchProducts_withRealData_shouldReturnNotEmptyList() {
        // given
        String keyword = "í—¤ë“œí°";
        SearchSort sort = SearchSort.ACCURACY;

        // when
        List<Product> result = service.TokenizedSearch(keyword, sort);

        // then
        assertNotNull(result);
        assertFalse(result.isEmpty(), "ê²€ìƒ‰ ê²°ê³¼ê°€ ìµœì†Œ 1ê°œ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
        Product top = result.get(0);
        log.info("TOP ìƒí’ˆID: {}, ìƒí’ˆëª…: {}, ì´ë¯¸ì§€: {}", top.getProductId(), top.getProductName(), top.getProductImg());
        assertTrue(top.getProductName().contains("í—¤ë“œí°") || 
                (top.getProductImg() != null && !top.getProductImg().isBlank()));
    }

    @Test
    void searchProducts_withNoResult_shouldReturnEmptyList() {
        // given
        String keyword = "ì§„ì§œì—†ëŠ”í‚¤ì›Œë“œ";
        SearchSort sort = SearchSort.ACCURACY;

        // when
        List<Product> result = service.TokenizedSearch(keyword, sort);

        // then
        assertNotNull(result);
        assertTrue(result.isEmpty(), "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í‚¤ì›Œë“œëŠ” 0ê±´ì´ì–´ì•¼ í•¨");
    }

    @Test
    void searchProducts_latestSort_shouldReturnLatestFirst() {
        // given
        String keyword = "í—¤ë“œí°";
        SearchSort sort = SearchSort.LATEST;

        // when
        List<Product> result = service.TokenizedSearch(keyword, sort);

        // then
        assertNotNull(result);
        assertFalse(result.isEmpty());

        if (result.size() > 1 && result.get(0).getRegDate() != null && result.get(1).getRegDate() != null) {
            assertTrue(result.get(0).getRegDate().compareTo(result.get(1).getRegDate()) >= 0,
                    "ìµœì‹ ìˆœ ì •ë ¬ì´ ë˜ì–´ì•¼ í•¨");
        }
    }

    @Test
    void searchProducts_accuracySort_logicalRelevance() {
        // given
        String keyword = "í—¤ë“œí°";
        SearchSort sort = SearchSort.ACCURACY;
        String[] tokens = keyword.trim().split("\\s+");

        // when
        List<Product> result = service.TokenizedSearch(keyword, sort);

        // then
        assertNotNull(result);
        assertFalse(result.isEmpty());

        // í† í° í¬í•¨ ì ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ ê²€ì¦
        int prevScore = Integer.MAX_VALUE;
        for (Product p : result) {
            int score = 0;
            String name = p.getProductName() == null ? "" : p.getProductName();
            for (String tk : tokens) {
                if (name.contains(tk)) score += 10;
                // í•„ìš”í•˜ë©´ ì¹´í…Œê³ ë¦¬/ì„œë¸Œì¹´í…Œê³ ë¦¬ëª…ë„ ê²€ì‚¬
            }
            log.info("ìƒí’ˆëª…: {}, í† í°í¬í•¨ì ìˆ˜: {}", name, score);

            assertTrue(score <= prevScore,
                String.format("ì •í™•ë„ìˆœ ì •ë ¬ ì˜¤ë¥˜: %s(%d) â†’ %s(%d)", name, prevScore, name, score));
            prevScore = score;
        }
    }

    @Test
    void searchProducts_accuracySort_multiTokens() {
        // given
        String keyword = "ë³´ìŠ¤ í—¤ë“œí°";
        SearchSort sort = SearchSort.ACCURACY;
        String[] tokens = keyword.trim().split("\\s+");

        // when
        List<Product> result = service.TokenizedSearch(keyword, sort);

        // then
        assertNotNull(result);
        assertFalse(result.isEmpty());

        int prevScore = Integer.MAX_VALUE;
        for (Product p : result) {
            int score = 0;
            String name = p.getProductName() == null ? "" : p.getProductName();
            for (String tk : tokens) {
                if (name.contains(tk)) score += 10;
            }
            log.info("ìƒí’ˆëª…: {}, í† í°í¬í•¨ì ìˆ˜: {}", name, score);
            assertTrue(score <= prevScore,
                String.format("ì •í™•ë„ìˆœ ì •ë ¬ ì˜¤ë¥˜: %s(%d) â†’ %s(%d)", name, prevScore, name, score));
            prevScore = score;
        }
    }
}
```
### ğŸ“Œ 0-7. mainsearch controller í…ŒìŠ¤íŠ¸ ì½”ë“œ
- mockMvcëŠ” springì˜ í…ŒìŠ¤íŠ¸ ì „ìš© ê°€ì§œ http í´ë¼ì´ì–¸íŠ¸ì´ë‹¤. ì‹¤ì œ í†°ìº£ì—†ì´ ì»¨íŠ¸ë¡¤ëŸ¬ë¶€í„° ë·°ê¹Œì§€ ì§„ì§œì²˜ëŸ¼ ë™ì‘í•˜ê²Œ í•´ì¤€ë‹¤.
- mockMvc.perform(get("/main_search")) : ì´ê±°ëŠ” /main_searchë¼ëŠ” URLë¡œ GET ìš”ì²­ì„ ë³´ë‚¸ë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤. í…ŒìŠ¤íŠ¸ mvc ê°ì²´ê°€ ëŒ€ì‹  performë©”ì„œë“œë¥¼ í†µí•´ì„œ ìš”ì²­ì„ ë³´ë‚´ì„œ í…ŒìŠ¤íŠ¸ í•´ì¤€ë‹¤.
- .param("q", "í—¤ë“œí°").param("sort", "accuracy") : ë©”ì„œë“œ ì²´ì´ë‹ ê¸°ë²•ìœ¼ë¡œ getìš”ì²­ì— íŒŒë¼ë¯¸í„°ë¥¼ ì „ì†¡í•œë‹¤. ê²°êµ­ /main_search?q=í—¤ë“œí°&sort=accuracy ì´ë ‡ê²Œ ì¶”ê°€ëœë‹¤.
- .andExpect(status().isOk()) : ì‘ë‹µ HTTP ìƒíƒœì½”ë“œê°€ 200 OKì—¬ì•¼ í•œë‹¤ ì¦‰ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì •ìƒì ìœ¼ë¡œ ë·°ë¥¼ ë°˜í™˜í•´ì•¼í•œë‹¤.
- .andExpect(view().name("main_search/search")) : ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë°˜í™˜í•œ ë·°ì˜ ì´ë¦„ì´ "main_search/search" ì´ì–´ì•¼ í•œë‹¤.
- .andExpect(model().attributeExists("products")) : ëª¨ë¸ ì•ˆì— products ì†ì„±ì´ ë°˜ë“œì‹œ ìˆì–´ì•¼ í•œë‹¤.
- .andExpect(model().attribute("sort", SearchSort.ACCURACY.getValue())) : modelì•ˆì— sort ì†ì„±ê°’ì´ ì •í™•íˆ accuracyì´ì–´ì•¼ í•œë‹¤.
- 7. .andExpect(model().attribute("keyword", "í—¤ë“œí°")) : ëª¨ë¸ì— keyword ì†ì„±ê°’ì´ ì •í™•íˆ í—¤ë“œí°ì´ì–´ì•¼í•œë‹¤.
```java
@SpringBootTest
@AutoConfigureMockMvc
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
class MainSearchControllerIntegrationTest {

    @Autowired
    MockMvc mockMvc;

    @DisplayName("ì •ìƒ ê²€ìƒ‰(ì •í™•ë„ìˆœ) í˜ì´ì§€ ë° ëª¨ë¸ ë°˜í™˜ í…ŒìŠ¤íŠ¸")
    @Test
    void search_accuracy_ok() throws Exception {
        mockMvc.perform(get("/main_search")
                        .param("q", "í—¤ë“œí°")
                        .param("sort", "accuracy"))
                .andExpect(status().isOk())
                .andExpect(view().name("main_search/search"))
                .andExpect(model().attributeExists("products"))
                .andExpect(model().attribute("sort", SearchSort.ACCURACY.getValue()))
                .andExpect(model().attribute("keyword", "í—¤ë“œí°"));
    }

    @DisplayName("ì •ìƒ ê²€ìƒ‰(ìµœì‹ ìˆœ) í˜ì´ì§€ ë° ëª¨ë¸ ë°˜í™˜ í…ŒìŠ¤íŠ¸")
    @Test
    void search_latest_ok() throws Exception {
        mockMvc.perform(get("/main_search")
                        .param("q", "í—¤ë“œí°")
                        .param("sort", "latest"))
                .andExpect(status().isOk())
                .andExpect(view().name("main_search/search"))
                .andExpect(model().attributeExists("products"))
                .andExpect(model().attribute("sort", SearchSort.LATEST.getValue()))
                .andExpect(model().attribute("keyword", "í—¤ë“œí°"));
    }

    @DisplayName("ê²€ìƒ‰ ì„œë¹„ìŠ¤ ì—ëŸ¬ ë°œìƒ ì‹œ 500í˜ì´ì§€ ì´ë™")
    @Test
    void search_service_error_500() throws Exception {
        // 'ì—ëŸ¬ ë°œìƒ'ì„ íŠ¸ë¦¬ê±°í•˜ëŠ” íŠ¹ìˆ˜ í‚¤ì›Œë“œ ì…ë ¥, í˜¹ì€ ì‹¤ì œ ì„œë¹„ìŠ¤ì— í•´ë‹¹ ìƒí™© ë§ì¶° í…ŒìŠ¤íŠ¸
        mockMvc.perform(get("/main_search")
                        .param("q", "")) // ì˜ˆì‹œ: ê³µë°± í‚¤ì›Œë“œ ë“±
                .andExpect(status().isOk())
                .andExpect(view().name("main_search/search")); // ê³µë°±ì´ì–´ë„ ë³´í†µ searchë¡œ ê°€ì§€ë§Œ, í•„ìš” ì‹œ error/500ë¡œ
    }
}
```

# ğŸ“Œ 1. ìˆ˜ì—… - íšŒì›ê°€ì…
### ğŸ“Œ 1-1. session ì§ë ¬í™”
- ì„¸ì…˜ì— ë„£ì„ í…Œì´ë¸”ì— ì§ë ¬í™” ì˜µì…˜ì„ ì¶”ê°€í•˜ì—¬ ì„¸ì…˜ì— ë„£ì„ë•Œ ì•ˆì „í•œ ì ˆì°¨ë¡œ ë„£ì„ ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤.
```java
@Data
public class Member implements Serializable {
    private int id;          // ì¼ë ¨ë²ˆí˜¸
    private String userId;   // ì•„ì´ë””
    private String userPw;   // ë¹„ë°€ë²ˆí˜¸(ì•”í˜¸í™”ì €ì¥)
    private String userName; // íšŒì›ì´ë¦„
    private String email;    // ì´ë©”ì¼
    private String phone;    // ì—°ë½ì²˜
    private String birthday; // ìƒë…„ì›”ì¼
    private String gender;   // ì„±ë³„(M=ë‚¨ì,F=ì—¬ì)
    private String postcode; // ìš°í¸ë²ˆí˜¸
    private String addr1;    // ê²€ìƒ‰ëœ ì£¼ì†Œ
    private String addr2;    // ë‚˜ë¨¸ì§€ ì£¼ì†Œ
    private String photo;    // í”„ë¡œí•„ì‚¬ì§„ ì •ë³´{json=UploadItem}
    private String isOut;    // íƒˆí‡´ì—¬ë¶€(Y/N)
    private String isAdmin;  // ê´€ë¦¬ì ì—¬ë¶€(Y/N)
    private String loginDate; // ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì¼ì‹œ
    private String regDate;   // ë“±ë¡ì¼ì‹œ
    private String editDate;  // ë³€ê²½ì¼ì‹œ

    private String newUserPw; // íšŒì›ì •ë³´ ìˆ˜ì •ì—ì„œ ì‚¬ìš©í•  ì‹ ê·œ ë¹„ë°€ë²ˆí˜¸
}
```

### ğŸ“Œ 1-2. ë°ì´í„° ë² ì´ìŠ¤ ì‹ ê·œ ìƒì„±ê³¼ ê¶Œí•œ ë¶€ì—¬
- ì‹ ê·œ ë°ì´í„° ë² ì´ìŠ¤ë¥¼ ìƒì„±í•˜ê³  ì‚¬ìš©ìì™€ ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìƒì„±í•œë‹¤. ê·¸ë¦¬ê³  ê·¸ ì‚¬ìš©ìì—ê²Œ myshopì˜ ëª¨ë“  ê¶Œí•œì„ ë¶€ì—¬í•œë‹¤.
```sql
CREATE DATABASE IF NOT EXISTS `myshop` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
CREATE USER 'myshop'@'localhost' IDENTIFIED BY '1234';
GRANT ALL PRIVILEGES ON myshop.* TO 'myshop'@'localhost';
```
- ì‹¤ìŠµì„ ìœ„í•œ í…Œì´ë¸”ì„ ìƒì„±í•˜ê³  ì„¸ì…˜ dbë¥¼ ìƒì„±í•œë‹¤.
```sql
USE myshop;
-- members í…Œì´ë¸” ìƒì„±
CREATE TABLE `members` (
    `id` INT(11) NOT NULL AUTO_INCREMENT COMMENT 'ì¼ë ¨ë²ˆí˜¸',
    `user_id` VARCHAR(30) NOT NULL COMMENT 'ì•„ì´ë””',
    `user_pw` VARCHAR(255) NOT NULL COMMENT 'ë¹„ë°€ë²ˆí˜¸(ì•”í˜¸í™”ì €ì¥)',
    `user_name` VARCHAR(30) NOT NULL COMMENT 'íšŒì›ì´ë¦„',
    `email` VARCHAR(255) NOT NULL COMMENT 'ì´ë©”ì¼',
    `phone` VARCHAR(20) NOT NULL COMMENT 'ì—°ë½ì²˜',
    `birthday` DATE NOT NULL COMMENT 'ìƒë…„ì›”ì¼',
    `gender` ENUM('M', 'F') NOT NULL COMMENT 'ì„±ë³„(M=ë‚¨ì,F=ì—¬ì)',
    `postcode` CHAR(5) NOT NULL COMMENT 'ìš°í¸ë²ˆí˜¸',
    `addr1` VARCHAR(255) NOT NULL COMMENT 'ê²€ìƒ‰ëœ ì£¼ì†Œ',
    `addr2` VARCHAR(255) NOT NULL COMMENT 'ë‚˜ë¨¸ì§€ ì£¼ì†Œ',
    `photo` VARCHAR(255) NULL COMMENT 'í”„ë¡œí•„ì‚¬ì§„ ì •ë³´',
    `is_out` ENUM('Y', 'N') NOT NULL COMMENT 'íƒˆí‡´ì—¬ë¶€(Y/N)',
    `is_admin` ENUM('Y', 'N') NOT NULL COMMENT 'ê´€ë¦¬ì ì—¬ë¶€(Y/N)',
    `login_date` DATETIME NULL DEFAULT NULL COMMENT 'ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì¼ì‹œ',
    `reg_date` DATETIME NOT NULL COMMENT 'ë“±ë¡ì¼ì‹œ',
    `edit_date` DATETIME NOT NULL COMMENT 'ë³€ê²½ì¼ì‹œ',
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='íšŒì›';

-- SPRING_SESSION í…Œì´ë¸” ìƒì„±
CREATE TABLE SPRING_SESSION (
    PRIMARY_ID CHAR(36) NOT NULL,
    SESSION_ID CHAR(36) NOT NULL,
    CREATION_TIME BIGINT NOT NULL,
    LAST_ACCESS_TIME BIGINT NOT NULL,
    MAX_INACTIVE_INTERVAL INT NOT NULL,
    EXPIRY_TIME BIGINT NOT NULL,
    PRINCIPAL_NAME VARCHAR(100),
    CONSTRAINT SPRING_SESSION_PK PRIMARY KEY (PRIMARY_ID)
);

CREATE UNIQUE INDEX SPRING_SESSION_IX1 ON SPRING_SESSION (SESSION_ID);
CREATE INDEX SPRING_SESSION_IX2 ON SPRING_SESSION (EXPIRY_TIME);
CREATE INDEX SPRING_SESSION_IX3 ON SPRING_SESSION (PRINCIPAL_NAME);

-- SPRING_SESSION_ATTRIBUTES í…Œì´ë¸” ìƒì„±
CREATE TABLE SPRING_SESSION_ATTRIBUTES (
       SESSION_PRIMARY_ID CHAR(36) NOT NULL,
       ATTRIBUTE_NAME VARCHAR(200) NOT NULL,
       ATTRIBUTE_BYTES BLOB NOT NULL,
       CONSTRAINT SPRING_SESSION_ATTRIBUTES_PK PRIMARY KEY (SESSION_PRIMARY_ID, ATTRIBUTE_NAME),
       CONSTRAINT SPRING_SESSION_ATTRIBUTES_FK FOREIGN KEY (SESSION_PRIMARY_ID) REFERENCES SPRING_SESSION(PRIMARY_ID) ON DELETE CASCADE
);
```