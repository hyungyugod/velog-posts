name: Sync Velog Posts to GitHub

on:
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ ìì •(UTC) ì‹¤í–‰ (í•œêµ­ ì‹œê°„ ì˜¤ì „ 9ì‹œ)
  workflow_dispatch:

jobs:
  sync-posts:
    runs-on: ubuntu-latest

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: GitHub ì¸ì¦ ì„¤ì • (GITHUB_TOKEN ì‚¬ìš©)
        run: |
          # GitHub Actions ì „ìš© ê³„ì •ìœ¼ë¡œ ì„¤ì •
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # GITHUB_TOKENì„ í¬í•¨í•œ ì›ê²© URLë¡œ ì„¤ì •í•˜ì—¬ ì¸ì¦ ë¬¸ì œ í•´ê²°
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/hyungyugod/velog-posts.git
          # ì›ê²© ì €ì¥ì†Œì˜ ìµœì‹  ë³€ê²½ ì‚¬í•­ì„ ê°€ì ¸ì™€ ì¶©ëŒ ë°©ì§€
          git pull origin main --rebase || true

      - name: Velog RSSì—ì„œ ìµœì‹  í¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
        run: |
          mkdir -p posts
          RSS_URL="https://v2.velog.io/rss/@hyungyugod"
          # RSS í”¼ë“œì—ì„œ í¬ìŠ¤íŠ¸ ë§í¬ ì¶”ì¶œ
          curl -s "$RSS_URL" | grep -oP '(?<=<link>https://velog.io/@hyungyugod/).*?(?=</link>)' | while read -r post; do
            # ì•ˆì „í•œ íŒŒì¼ëª…ìœ¼ë¡œ ë³€í™˜ (íŠ¹ìˆ˜ë¬¸ì ì œê±°) í›„ .md í™•ì¥ì ì¶”ê°€
            filename=$(echo "$post" | sed 's/[^a-zA-Z0-9._-]/_/g').md
            # Markdown í˜•ì‹ì˜ íŒŒì¼ ë‹¤ìš´ë¡œë“œ (Velogì—ì„œ ì‹¤ì œ Markdown íŒŒì¼ ì œê³µí•˜ëŠ” ê²½ìš°)
            curl -s "https://velog.io/@hyungyugod/$post.md" -o "posts/$filename"
            # ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ ì‹œ (0ë°”ì´íŠ¸ íŒŒì¼) ì‚­ì œ
            [ -s "posts/$filename" ] || rm -f "posts/$filename"
          done

      - name: ë³€ê²½ ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        run: |
          git add posts/
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ”„ ìë™ ë™ê¸°í™”: Velog í¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸"
            git push origin main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

